define(["trackingbase","tsatracking","crosspixeltracking"],function(e){var t={},n={};return t.Page=Backbone.View.extend({prevReg:"N",prevLoc:"",isLoggedOut:!0,initialize:function(e){_.bindAll(this,"track","setTrackingVar","setBase","trackSearch","trackForm","trackAction","trackSessionChange","trackSwitchClick","trackClick","addClientBase","tsaTrack","trackConv","formFocus","setDefaultSearchTab");var n=this;this.openmodals={},this.model=new t.Vars,HMSEvent.on("SetTrackingVar",this.setTrackingVar),HMSEvent.on("TrackSearch",this.trackSearch),HMSEvent.on("TrackForm",this.trackForm),HMSEvent.on("TrackAction",this.trackAction),HMSEvent.on("TrackSessionChange",this.trackSessionChange),HMSEvent.on("TrackRemarketing",this.trackRemarketing,this),HMSEvent.on("trackSwitchClick",this.trackSwitchClick),HMSEvent.on("notifytracking-modalopen",this.onModalOpen,this),HMSEvent.on("notifytracking-modalclose",this.onModalClose,this),HMSEvent.on("formFocusTrack",this.formFocus,this),HMSEvent.on("onUserLoggedOut",function(e){n.isLoggedOut=!0}),$("body").on("click","[data-trackAction]",this.trackClick),this.formFocusTrackUpper=!1,this.formFocusTrackLower=!1,this.doDocWriteScripts(),this.setDefaultSearchTab(),this.setBase(),this.track(),this.tsaTrack(),this.trackAdobeTag(),HMSEvent.trigger("onTrackerReady"),HMSEvent.on("onUserLoggedIn",this.onUserLoggedIn,this)},onUserLoggedIn:function(){},formFocus:function(e){var t=e.ContactFormType;e.ResetForm&&(this.formFocusTrackUpper=!1,this.formFocusTrackLower=!1),t&&(t&&t=="moreinfo"?this.formFocusTrackLower||(this.formFocusTrackLower=!0,this.trackForm({formid:t,status:"T"})):this.formFocusTrackUpper||(this.formFocusTrackUpper=!0,this.trackForm({formid:t,status:"T"})))},tsaTrack:function(e){var t="3604437",n;if(e){n=new Image;switch(e){case"leadf908":result=this.tsaExecute(817,11145,t,"conve331","leadf908","ad.doubleclick.net/activity",null,"formfillout",n)}return result}if(typeof HMSTrackingVars!="undefined"){var r=HMSTrackingVars.PageName;this.tsaExecute(817,8495,t,"retar685","landi648","fls.doubleclick.net/activityi",$('<iframe id="frmTSA" width="1" height="1" frameborder="0" style="display:none"></iframe>'));switch(r){case"Property Search Results":this.tsaExecute(817,8505,t,"conve331","finda896","ad.doubleclick.net/activity",$('<img id="imgTSA" width="1" height="1" alt="" />'),"findAhome");break;case"Agent Search Results":this.tsaExecute(817,8535,t,"conve331","finda404","ad.doubleclick.net/activity",$('<img id="imgTSA" width="1" height="1" alt="" />'),"findAgent");break;case"Listing Details":this.tsaExecute(817,11335,t,"conve331","listi929","ad.doubleclick.net/activity",$('<img id="imgTSA" width="1" height="1" alt="" />'),"visit")}}},loadPix:function(e){var t=Math.random()+"",n=$("<script></script>"),r;t*=1e6,r="HTTP://bs.serving-sys.com/BurstingPipe/ActivityServer.bs?cn=as&ActivityID="+e+"&rnd="+t,n.attr("src",r),$("body").append(n)},tsaExecute:function(e,t,n,r,i,s,o,u,a){if(typeof TSATrackingAPI!="undefined"){var f=new TSATrackingAPI(e,t);u&&f.addConversion(u),f.record()}var l=Math.random()+"",c=l*1e13,h="http://"+s+";src="+n+";type="+r+";cat="+i+";ord="+c+"?";if(a)return a.src=h,!0;o.attr("src",h),$("body").append(o)},onModalOpen:function(e){e&&e.content&&e.content.indexOf&&(e.content.indexOf("js-rmx-login")!=-1&&(this.openmodals.signin=!0),e.content.indexOf("js-rmx-register")!=-1&&(this.openmodals.registration=!0),e.content.indexOf("js-modal-location")!=-1&&(this.openmodals.changelocation=!0),e.content.indexOf("js-modal-property")!=-1&&(this.openmodals.changepropertytype=!0)),e&&e.contactform&&(this.openmodals[e.contactform]=!0);var t=this;$.each(this.openmodals,function(e,n){n&&t.trackForm({formid:e,status:"O"})})},onModalClose:function(){var e=this;$.each(this.openmodals,function(t,n){n&&(e.trackForm({formid:t,status:"C"}),(t=="signin"||t=="registration")&&HMSEvent.trigger("onLoginRegisterCancelled"))})},trackSwitchClick:function(e){var t=e.action;this.model.set("Action",t),this.trackAction()},setDefaultSearchTab:function(){if($(".js-ui-active")&&HMSTrackingVars["PageName"]=="Property Search Results"){var e=$(".js-ui-active").attr("data-trackAction");this.model.set("Action",e),this.model.set("CurrentTab",e)}},trackClick:function(e){var t=$(e.currentTarget).attr("data-trackAction");this.model.set("Action",t);if($(".js-ui-active")&&HMSTrackingVars["PageName"]=="Property Search Results"){var t=$(".js-ui-active").attr("data-trackAction");this.model.set("TabClicked",t)}this.trackAction()},trackConv:function(e){var t=$(e.currentTarget).attr("data-trackConv");if(this.tsaTrack(t))return!0},trackSessionChange:function(e){this.model.set("Events","event2"),this.track()},trackAction:function(e){this.model.cleanUp(),this.model.set("Events","event8"),this.track(e)},trackForm:function(e){var t="unknown",n="U",r="N",i="N",s="N",o="N";e&&e.formid&&(t=e.formid),e&&e.status&&(n=e.status),e.status!="O"&&(this.openmodals[t]=!1);var u=null;HMSUser&&HMSUser.model&&(u=HMSUser.model.toJSON()),u&&u.userId&&parseInt(u.userId)>0?(this.model.set("UserID",u.userId),this.model.set("Registered","Y")):this.model.set("Registered","N"),this.model.set("FormType",this.model.formNames[t]),this.model.set("FormStatus",this.model.statusNames[n]);var a=this.model.attributes.FormType;n!="S"||a!="Registration"&&a!="Home Values Inquiry"&&a!="Contact Remax"&&a!="Upper Property Inquiry"&&a!="Lower Property Inquiry"&&a!="Contact Agent"&&a!="Contact Office"&&a!="HomeValueInquiry"?this.model.set("Events","event6"):this.model.set("Events","event9"),e&&e.SocialID&&(e.SocialID=="facebook"?(this.model.set("Facebook","Y"),this.model.set("Google","N"),this.model.set("Twitter","N"),this.model.set("Linkedin","N")):e.SocialID=="google"?(this.model.set("Facebook","N"),this.model.set("Google","Y"),this.model.set("Twitter","N"),this.model.set("Linkedin","N")):e.SocialID=="twitter"?(this.model.set("Facebook","N"),this.model.set("Google","N"),this.model.set("Twitter","Y"),this.model.set("Linkedin","N"),this.model.set("Events",["event10","event6"])):e.SocialID=="linkedin"&&(this.model.set("Facebook","N"),this.model.set("Google","N"),this.model.set("Twitter","N"),this.model.set("Linkedin","Y"),this.model.set("Events",["event10","event6"]))),this.track(),this.trackAdobeTag(),n=="S"&&(t=="signin"||t=="registration"||t=="signout")&&this.prevReg!=this.model.get("Registered")&&(this.trackSessionChange(),this.prevReg=this.model.get("Registered")),n=="S"&&(this.tsaTrack("leadf908"),this.loadPix("298517"))},trackSearch:function(e){this.model.cleanUp();var t=e.Location,n;this.prevLoc!=t&&(this.model.set("Events","event7"),n=this.track(e)),e.tabClick||(this.model.set("Events","event8"),this.model.set("Action","Refine Search"),this.track(e))},setBase:function(){typeof HMSTrackingVars!="undefined"&&(this.setTrackingVar(HMSTrackingVars),this.addClientBase())},addClientBase:function(){this.model.set("PageURL",window.location.pathname),this.model.set("AssignedAgentID",$.cookie("rmxaid")),this.model.set("BrandedAgentID",$.cookie("rmxaidlistingreferred")),this.model.set("Semparameter",s.getQueryParam("utm_source,utm_medium,utm_campaign",":"))},track:function(e){e&&_.extend(this.model.attributes,e),this.model.copyTo(s);var t=s.t();t&&document.write(t);var n=this.model.toJSON();return this.commonTracker(n),this.prevLoc=this.model.get("Location"),!0},setTrackingVar:function(e){var t=this.model;$.each(e,function(e,n){t.set(e,n)})},trackRemarketing:function(){var e=document.write;this.writeRemarketing({callback:this.retrieveDocumetWrite,args:e})},writeRemarketing:function(e){window.google_conversion_id=988891588,window.google_conversion_label="oKfcCPSE4wQQxJPF1wM",window.google_custom_params=window.google_tag_params,window.google_remarketing_only=!0,$.getScript("//www.googleadservices.com/pagead/conversion.js",function(){e&&e.callback&&e.args&&e.callback(e.args)})},doDocWriteScripts:function(){var e=HMSTrackingVars.PageName,t=Math.random()+"",n,r,i=document.write,s=HMSTrackingVars.Tab;t*=1e6,r="http://bs.serving-sys.com/BurstingPipe/ActivityServer.bs?cn=as&ActivityID=%id%&rnd="+t;switch(e){case"Home Page":n=[180084,298513],this.writeRemarketing({callback:this.retrieveDocumetWrite,args:i});break;case"Agent/Office Search Form":n=[180084];break;case"Property Search Results":n=[298514],s=="list"&&this.writeRemarketing({callback:this.retrieveDocumetWrite,args:i});break;case"Agent Search Results":n=[298515];break;case"Home Values Results":n=[298516]}n&&n.length>0&&this.writeScript({actIDs:n,url:r,callback:this.retrieveDocumetWrite,args:i})},writeScript:function(e){var t=e.actIDs,n=e.url,r;$.isArray(t)||(t=[t]);for(var i=0;i<t.length;i++)r=n.replace("%id%",t[i]),$.getScript(r,function(){e&&e.callback&&e.args&&e.callback(e.args)})},trackAdobeTag:function(e){e||(e=this.model.toJSON()),this.writeAdobeTag(e)},writeAdobeTag:function(e){var t="",n="",r="";e&&e.FormType&&e.FormStatus!="Cancelled"&&e.FormType=="Registration"&&(this.isLoggedOut?(t="formSubmit",this.isLoggedOut=!1):t="",n=e.FormType),e&&e.FormType&&e.FormStatus!="Cancelled"&&(e.FormType=="HomeValueInquiry"||e.FormType=="Upper Property Inquiry"||e.FormType=="Lower Property Inquiry"||e.FormType=="Contact Office"||e.FormType=="Contact Agent")&&(t="formSubmit",n=e.FormType);if(e&&e.PageName=="Agent Search Results"||e.PageName=="Home Values Results"||e.PageName=="Property Search Results")if(e.FormType&&e.FormType==""||e.FormType==null)t=e.PageName,n=e.PageName;window.HMSTrackingVars!=this.model.toJSON()&&(window.HMSTrackingVars=this.model.toJSON());switch(t){case"formSubmit":$.getScript("//www.adobetag.com/d1/v2/ZDEtZGVyZW1heC0xMjg0Ni0zMTc2/amc.js",function(){});break;case"Agent Search Results":$.getScript("//www.adobetag.com/d1/v2/ZDEtZGVyZW1heC0xMjg0Ni0zMTc3/amc.js",function(){});break;case"Home Values Results":$.getScript("//www.adobetag.com/d1/v2/ZDEtZGVyZW1heC0xMjg0Ni0zMTc4/amc.js",function(){});break;case"Property Search Results":$.getScript("//www.adobetag.com/d1/v2/ZDEtZGVyZW1heC0xMjg0Ni0zMTc5/amc.js",function(){})}},commonTracker:function(e){var t="",n="";if(document.createEvent){var r=document.createEvent("Event");r.initEvent("REMAX_TRACKING",!0,!1),r.model=e,document.dispatchEvent(r)}else document.createEventObject&&(window.rmxModel=e,document.documentElement.jqmReady++)}}),t.Vars=Backbone.Model.extend({name:"js-tracking-model",vars:{},config:{Server:["server"],Channel:["channel"],PageURL:["eVar21"],PageName:["pageName"],PageType:["pageType"],Events:["events"],BusinessUnit:["eVar1","prop1"],Site:["eVar2","prop2"],SiteLevel:["eVar3","prop3"],SourcePlatform:["eVar4","prop4"],Location:["eVar5","prop5"],SearchResultHost:["eVar6","prop6"],Country:["eVar7","prop7"],Region:["eVar8","prop8"],SponsoringOfficeID:["eVar10","prop10"],LSID:["eVar11","prop11"],MLSNumber:["eVar12","prop12"],BrandedAgentID:["eVar13","prop13"],FormType:["eVar14","prop14"],FormStatus:["eVar15","prop15"],UserID:["eVar16","prop16"],Registered:["eVar17","prop17"],Facebook:["eVar18","prop18"],TestScenario:["eVar19","prop19"],AssignedAgentID:["eVar20","prop20"],Action:["eVar26"],Semparameter:["eVar27"],Google:["eVar28","prop27"],Twitter:["eVar29","prop28"],Linkedin:["eVar30","prop29"]},formNames:{unknown:"Unknown",signin:"Sign In",signout:"Sign Out",registration:"Registration",changelocation:"Change Location",changepropertytype:"Change Property Type",requestshowing:"Upper Property Inquiry",requestshowings:"Upper Property Inquiry",moreinfo:"Lower Property Inquiry",homevalueinquiry:"HomeValueInquiry","requestshowing-modal":"Property Inquiry",valueestimate:"Home Values Inquiry",valueestimatewide:"Home Values Inquiry",getintouch:"Contact Agent","getintouch-modal":"Contact Agent",contactoffice:"Contact Office","contactoffice-modal":"Contact Office",contactagent:"Contact Remax","contactagent-modal":"Contact Remax",contactagentoffice:"Contact Remax"},statusNames:{A:"Abandoned",S:"Submitted",C:"Cancelled",U:"Unknown",O:"Opened",T:"Text Entered"},initialize:function(e){_.bindAll(this,"copyTo")},copyTo:function(e){var t=this.config;$.each(this.attributes,function(n,r){var i=t[n];$.isArray(i)?$.each(i,function(t,n){e[n]=r}):e[i]=r})},cleanUp:function(){this.set("FormType",null),this.set("FormStatus",null)}}),n.execute=function(e){return new t.Page(e)},n});var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-36821340-1"]),_gaq.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()