define(["backbonestore","app/mediators/form","app/ui-modules/share/models/model"],function(e,t,n){var r={},i={},s="text!app/ui-modules/share/template/sendemailtofriend-modal.html";i.View=e.View.extend({initialize:function(e){_.bindAll(this,"render","renderCallback","sendForm","onUserReady"),this.settings=e,this.model=new n.SendEmailToFriend({siteid:68e6}),HMSEvent&&HMSEvent._callbacks&&!HMSEvent._callbacks["save-"+this.model.name]&&HMSEvent.on("save-"+this.model.name,this.sendForm),this.mediator=t.Mediator({model:this.model}),HMSEvent.on("onUserReady",this.onUserReady,this),HMSEvent.on("onUserLoggedIn",this.onUserReady,this),HMSEvent.trigger("onSendEmailToFriendReady")},onUserReady:function(){var e="";if(HMSUser&&!HMSUser.isLoggedout()){e=$(this.el).find('input[name="fullName"]').val();if(e==""||e==" ")$(this.el).find('input[name="fullName"]').val(HMSUser.model.get("firstName")+" "+HMSUser.model.get("lastName")),this.model.set("fullName",HMSUser.model.get("firstName")+" "+HMSUser.model.get("lastName"));e=$(this.el).find('input[name="email"]').val();if(e==""||e==" ")$(this.el).find('input[name="email"]').val(HMSUser.model.get("email")),this.model.set("email",HMSUser.model.get("email"));e=$(this.el).find('input[name="phone"]').val();if(e==""||e==" ")$(this.el).find('input[name="phone"]').val(HMSUser.model.get("phone")),this.model.set("phone",HMSUser.model.get("phone"))}},render:function(e){this.data=e,HMSTemplate.get(s,this.renderCallback)},renderCallback:function(t){var n=this.data,r="",i=new e.Model;n.listingid?i.loadFromMData({el:$('.js-listitem[data-listingid="'+n.listingid+'"]')}):i.loadFromMData({el:".js-listitem"}),HMSUser&&HMSUser.model&&i.set(HMSUser.model),!i.get("ShareType")&&n.sharetype&&(i.set("ShareType",n.sharetype),n.sharetype=="listing"&&i.set("Title",i.get("Address")),n.sharetype=="foreclosure"&&i.set("Title",i.get("StreetName")),n.sharetype=="agent"&&i.set("Title",i.get("AgentFirstName")+" "+i.get("AgentLastName"))),n.searchtype&&i.set("SearchType",n.searchtype),!i.get("firstName")&&$.cookie("lastFirstName")&&i.set("firstName",$.cookie("lastFirstName")),!i.get("lastName")&&$.cookie("lastLastName")&&i.set("lastName",$.cookie("lastLastName")),!i.get("email")&&$.cookie("lastEmail")&&i.set("email",$.cookie("lastEmail")),!i.get("phone")&&$.cookie("lastPhone")&&i.set("phone",$.cookie("lastPhone")),r=t.render(i.toJSON()),HMSEvent.trigger("ui-modal-open",{content:r}),this.el="#js-sendemailtofriend",$(this.el).find("button").parents("fieldset").prepend('<input type="text" name="LeadID" class="hidden" value=""/>'),this.setElement(this.el),this.mediator.prepareModel($(this.el)),HMSEvent.trigger("onSendEmailToFriendRenderedComplete")},sendForm:function(e){var t=this,n=this.data,r="#js-sendemailtofriend";HMSEvent.trigger("ui-show-blocker",{element:r}),n&&n.listingid&&n.listingid>0&&e.set("ListingID",n.listingid),n&&n.hvlistingid&&n.hvlistingid>0&&e.set("HVListingID",n.hvlistingid),n&&n.searchtype&&(n.searchtype=="homevalues"&&$.cookie("g_strLastHomeValueSearch")&&e.set("SearchQueryString",$.cookie("g_strLastHomeValueSearch")),n.searchtype=="recentsales"&&$.cookie("g_strLastHomeValueSearch")&&e.set("SearchQueryString",$.cookie("g_strLastHomeValueSearch")),n.searchtype=="idxsearch"&&$.cookie("g_strLastSearch")&&e.set("SearchQueryString",$.cookie("g_strLastSearch")),n.searchtype=="agentsearch"&&$.cookie("g_strAgentLastSearch")&&e.set("SearchQueryString",$.cookie("g_strAgentLastSearch")),n.searchtype=="officesearch"&&$.cookie("g_strOfficeLastSearch")&&e.set("SearchQueryString",$.cookie("g_strOfficeLastSearch"))),e.save(null,{success:function(e,t){HMSEvent.trigger("ui-hide-blocker",{element:r}),t.success==0&&HMSEvent.trigger("ui-notify",{msg:t.message}),HMSEvent.trigger("ui-modal-close")}})}});var o=null;return r.showModal=function(e){o||(o=new i.View),o.render(e)},r})