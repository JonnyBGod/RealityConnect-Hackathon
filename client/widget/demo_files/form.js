define(["backbonestore","app/models/formmanager","hmsglobal","openajax","formvalidation","tooltip"],function(e,t,n){var r={};r.View=e.View.extend({settings:{},prepped:!1,initialize:function(e){var t=this;_.bindAll(this,"updateModel","prepareModel","setReadyState","setAttribute","cleanPrice"),_.extend(this.settings,e),this.model.on("change",this.updateModel)},events:{"blur input[type='price']":"updateText","blur input[type='search']":"updateText","blur input[type='text']":"updateText","blur input[type='password']":"updateText","blur input[type='email']":"updateText","blur input[type='phone']":"updateText","blur input[type='tel']":"updateText","blur input[data-type='price']":"updateText","keypress input":"handleKeypress","keypress button[type='submit']":"handleKeypress","keypress a.submit":"handleKeypress","keypress select":"handleKeypress","click button[type='submit']":"saveModel","click a.submit":"saveModel","click input[type='checkbox']":"updateCheckbox","click input[type='radio']":"updateRadio","change select":"updateSelect","blur textarea":"updateTextarea","click a.clear":"clearForm","click button[type='clear']":"clearForm","change input[type='hidden']":"updateText"},prepareModel:function(t){var n=this;t.hasClass(this.model.name)||t.addClass(this.model.name),this.loadAttributes(),this.setElement($("."+this.model.name)),this.setMultiSelect(),this.$el.find(":input").each(function(){var e=$(this);n.setAttribute(e,n)}),$("[data-mask]").each(function(e,t){var n=$(t).data("mask");$(t).mask(n)}),this.addPlugins(),this.prepped=!0},setMultiSelect:function(){var e=this;$("[data-multiselect]").each(function(t,n){var r=$(n),i=r.data("multiselect"),s=$(i.labelOn),o=i.labelDefaultText,u=$(i.labelOff),a=i.labelClass,f=r.siblings().find("label"),l=r.siblings().find("input"),c=!1;l.each(function(e,t){$(f[e]).hasClass(a)?(t.checked=!0,c=!0):t.checked=!1}),r.unbind("updatelabel.multiselect").bind("updatelabel.multiselect",function(t){var r=l.filter("[checked]"),i=l.filter(":not([checked])"),f=r.parents("label"),c=i.parents("label");s.hide(),u.hide(),$.log(r.length);if(r.length==0)s.html(o),s.show(),$(n).qtip&&$(n).qtip("destroy");else if(r.length==1)s.html(f.text().trim()),s.show(),$(n).qtip&&$(n).qtip("destroy");else if(r.length>1){u.show();var h=e.reformatCopy(f);isTtip=!0,$(n).qtip({content:h,position:{my:"bottom center",at:"top center"},hide:{delay:1e3}})}f.addClass(a),c.removeClass(a)}),l.unbind("change.multiselect").bind("change.multiselect",function(e){r.trigger("updatelabel.multiselect")}),c&&$(n).trigger("updatelabel.multiselect")})},reformatCopy:function(e){var t=[];return $(e).each(function(e,n){t.push($(n).text().trim())}),t.toString()},setAttribute:function(e,t){var n,r="",i="";e=$(e),n=e.attr("type");switch(n){case"radio":r=$("input[type='radio'][name='"+e.attr("name")+"']:checked").val(),t.model.set(e.attr("name"),r);break;case"checkbox":_.each($("input[type='checkbox'][name='"+e.attr("name")+"']:checked"),function(e){r+=$(e).val()+","}),r&&r.lastIndexOf(",")==r.length-1&&(r=r.substring(0,r.length-1)),t.model.set(e.attr("name"),r);break;default:e.val()&&(r=e.val().trim()),i=e.data("value")?e.data("value")+"":r;var s=e.attr("placeholder");s&&(s=s.trim()),r==s&&(r=""),i==s&&(i=""),t.model.set(e.attr("name"),i),!$.browser.msie&&r!=""&&e.val(r)}},updateModel:function(){e.Store.saveState(this.model.name,this.model.attributes,7200)},loadAttributes:function(){var t=this,n=e.Store.loadState(this.model.name);n&&_.each(n,function(e,n){t.setModel(n,e);var r='*[name="'+n+'"]',i=$(r);i.attr("type")!="checkbox"&&i.val(e)})},updateText:function(e){var t=$(e.currentTarget);this.setValue(t)},updateSelect:function(e){var t=$(e.currentTarget);this.setValue(t)},updateCheckbox:function(e){var t=$(e.currentTarget),n=t.attr("name"),r=new Array,i="";_.each($("input[type='checkbox'][name='"+n+"']:checked"),function(e){r.push($(e).val())}),r.length>0&&(i=r.join()),this.setModel(n,i)},updateRadio:function(e){var t=$(e.currentTarget);this.setValue(t)},updateTextarea:function(e){var t=$(e.currentTarget);this.setValue(t)},setValue:function(e){var t=e.attr("name"),n=e.val();n&&(n=n.trim());var r=e.data("value")?e.data("value")+"":n,i=e.attr("type"),s=e.attr("placeholder");n==s&&(n=""),r==s&&(r=""),n!=r&&(r=n);if(i=="price"||e.attr("data-type")=="price")r=this.cleanPrice(r);this.setModel(t,r),e.val(n)},cleanPrice:function(e){var t=e;return t=t.replace("$","").replace(/,/g,""),t},setModel:function(e,t){var n={};n[e]=t,this.model.set(n)},getModel:function(e){return this.model.get(e)},saveModel:function(e){var t=$("."+this.model.name);if(t.length>0){e&&e.preventDefault();var n=this.model,r=0;_.each(n.attributes,function(e,n){var i=t.find('[name="'+n+'"]');i.length>0&&i.data("validation")&&i.ht5ifv&&!i.ht5ifv("valid")&&r++,n.toLowerCase().indexOf("password")!=-1&&(i=t.find('[name="'+n+'_confirm"]'),i.length>0&&i.data("validation")&&i.ht5ifv&&!i.ht5ifv("valid")&&r++)});var i=this;t.find("input[data-mask]").each(function(e,t){var n=$(t),r=n.attr("name");i.model.get(r)!=n.val()&&i.model.set(r,n.val())}),r===0&&(e&&this.model.set("currentTargetClassName",e.currentTarget.className),HMSEvent.trigger("save-"+n.name,this.model))}},setReadyState:function(){this.languageReady=!0},addPlugins:function(){var e=this;$.ht5ifv("extend",{types:{password:{restrictions:{type:function(e,t){var n=e.val(),r=!0;r=n==""&&t||/^[^\n\r]*$/.test(n);var i=!0,s=e.attr("name"),o=s.indexOf("_confirm");if(o!=-1){var u=$('[name="'+s.slice(0,o)+'"]');u.length>0&&(i=u.val()==e.val())}return r&&i}}},tel:{restrictions:{type:function(e,t){var n=e.val();return(n==""||n==e.attr("placeholder"))&&t||/^\(?(\d{3})\)?[- ]?(\d{3})[- ]?(\d{4})$/.test(n)}}},telint:{restrictions:{type:function(e,t){var n=e.val();return n==""&&t||/^((\+\d{1,3}(-| )?\(?\d\)?(-| )?\d{1,3})|(\(?\d{2,3}\)?))(-| )?(\d{3,4})(-| )?(\d{4})(( x| ext)\d{1,5}){0,1}$/.test(n)}}}}});if(n.languageCollection){var t=$("."+this.model.name),r=n.languageCollection.toJSON()[0];_.each(this.model.attributes,function(e,n){initdata={classes:{valid:"js-field-valid",invalid:"js-field-invalid",required:"js-field-required"},targets:{required:function(e){return e.parents("fieldset").first().find('*[data-validateId="'+e.attr("id")+'"]')},invalid:function(e){return e.parents("fieldset").first().find('*[data-validateId="'+e.attr("id")+'"]')}}};var r=t.find('[name="'+n+'"]');r.data("validation")&&r.ht5ifv(initdata);if(n.toLowerCase().indexOf("password")!=-1&&t.find('[name="'+n+'_confirm"]').length>0){var r=t.find('[name="'+n+'_confirm"]');r.data("validation")&&r.ht5ifv(initdata)}})}else setTimeout(e.addPlugins,20)},clearForm:function(){},handleKeypress:function(e){e.keyCode==13&&($(e.currentTarget).blur(),$(this.el).find("button").focus(),this.saveModel(e))}});var i={};return i.Mediator=function(e){var t=new r.View(e);return{prepareModel:function(n){return t.prepareModel(n),this},submit:function(n){return t.saveModel(n),this}}},i})