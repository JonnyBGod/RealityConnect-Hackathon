define(["backbonestore","app/mediators/form","app/ui-modules/leadcapture/models/model","app/shared/views/branding"],function(e,t,n,r){var i={},s={},o=!1;s.View=e.View.extend({events:{'change [name="requesttype"]':"switchMessages"},settings:{requestashowing:!1},initialize:function(e){this.renderFirstTime=!1,_.extend(this.settings,e.options),_.bindAll(this,"onUserReady","render","sendForm","switchMessages","formFocusTrack"),e&&e.options&&e.options.isHomeValue?this.settings.isHomeValue=e.options.isHomeValue:this.settings.isHomeValue=!1,this.model=new n.LeadCapture({siteid:68e6}),this.cftype="",$(this.el).data("contactformtype")&&(this.cftype=$(this.el).data("contactformtype"));var r=this;this.cftype&&$.get("http://"+window.location.hostname+"/resources/js/app/ui-modules/leadcapture/templates/"+this.cftype+".html",function(e){r.cftemplate=Hogan.compile(e),r.render()}),this.model.name+=this.cftype,this.model.set("ContactFormType",this.cftype),HMSEvent&&HMSEvent._callbacks&&!HMSEvent._callbacks["save-"+this.model.name]&&HMSEvent.on("save-"+this.model.name,this.sendForm),this.mediator=t.Mediator({model:this.model}),HMSEvent.on("onUserReady",this.onUserReady,this),HMSEvent.on("onUserLoggedIn",this.onUserReady,this),HMSEvent.trigger("onLeadCaptureReady"),o||(o=!0,HMSEvent.trigger("formFocusTrack",{ResetForm:!0}))},formFocusTrack:function(){var e=this;$("input").on("input propertychange",function(){e.formFocusTrackDispatch(this)}),$("textarea").on("input propertychange",function(){e.formFocusTrackDispatch(this)}),$("input[type='tel']").on("keyup",function(){e.formFocusTrackDispatch(this)})},formFocusTrackDispatch:function(e){formType=$(e).closest("section").attr("data-contactformtype")||$(e).closest("aside").attr("data-contactformtype"),formType&&HMSEvent.trigger("formFocusTrack",{ContactFormType:formType})},onUserReady:function(){var e="";if(HMSUser&&!HMSUser.isLoggedout()){e=$(this.el).find('input[name="fullName"]').val();if(e==""||e==" ")$(this.el).find('input[name="fullName"]').val(HMSUser.model.get("firstName")+" "+HMSUser.model.get("lastName")),this.model.set("fullName",HMSUser.model.get("firstName")+" "+HMSUser.model.get("lastName"));e=$(this.el).find('input[name="email"]').val();if(e==""||e==" ")$(this.el).find('input[name="email"]').val(HMSUser.model.get("email")),this.model.set("email",HMSUser.model.get("email"));e=$(this.el).find('input[name="phone"]').val();if(e==""||e==" ")$(this.el).find('input[name="phone"]').val(HMSUser.model.get("phone")),this.model.set("phone",HMSUser.model.get("phone"))}HMSEvent&&HMSEvent._callbacks&&!HMSEvent._callbacks["save-"+this.model.name]&&HMSEvent.on("save-"+this.model.name,this.sendForm)},render:function(){var t="",n=this,i=new e.Model;this.settings.ListingID?i.loadFromMData({el:$('.js-listitem[data-listingid="'+this.settings.ListingID+'"]')}):i.loadFromMData({el:".js-listitem"}),HMSUser&&HMSUser.model&&i.set(HMSUser.model),i.attributes.IsHomeValue=="False"&&i.attributes.IsForeclosure=="False"&&i.set("displayrequestmoreinfo",!0),i.attributes.IsHomeValue=="false"&&i.attributes.IsForeclosure=="false"&&i.set("displayrequestmoreinfo",!0),i.attributes.IsForeclosure&&i.attributes.IsForeclosure.toLowerCase()=="true"?(this.model.set("isforeclosure",!0),i.attributes.ForeclosureMoreInfo=!0):i.attributes.ForeclosureMoreInfo=null,this.settings.requestashowing?(i.set("requestashowing",!0),i.set("askaquestion",!1)):(i.set("requestashowing",!1),i.set("askaquestion",!0)),this.settings.AgentID&&i.set("AgentID",this.settings.AgentID),this.settings.AgentFirstName&&i.set("AgentFirstName",this.settings.AgentFirstName),!i.get("firstName")&&$.cookie("lastFirstName")&&i.set("firstName",$.cookie("lastFirstName")),!i.get("lastName")&&$.cookie("lastLastName")&&i.set("lastName",$.cookie("lastLastName")),!i.get("email")&&$.cookie("lastEmail")&&i.set("email",$.cookie("lastEmail")),!i.get("phone")&&$.cookie("lastPhone")&&i.set("phone",$.cookie("lastPhone"));var s,o,u;s=o=u="",i.get("firstName")&&(s=i.get("firstName")),i.get("lastName")&&(o=i.get("lastName")),u=(s+" "+o).trim(),u.length>0&&i.set("fullName",u),this.cftemplate&&(t=this.cftemplate.render(i.toJSON()),this.el='.js-contactform[data-contactformtype="'+this.cftype+'"]',$(this.el).replaceWith(t),$(this.el).find("button").parents("fieldset").prepend('<input type="text" name="LeadID" class="hidden" value=""/>'),this.setElement(this.el),this.mediator.prepareModel($(this.el)));if(this.cftype.indexOf("requestshowing")!=-1){var a="";this.cftype.indexOf("modal")!=-1&&(a="2"),this.settings.requestashowing?($('textarea[id="field-askaquestion'+a+'-message"]').hide(),$('textarea[id="field-requestashowing'+a+'-message"]').show(),$('textarea[id="field-requestashowing'+a+'-message"]').val($('textarea[id="field-requestashowing'+a+'-message"]').html()),this.model.set("Notes",$('textarea[id="field-requestashowing'+a+'-message"]').val())):($('textarea[id="field-requestashowing'+a+'-message"]').hide(),$('textarea[id="field-askaquestion'+a+'-message"]').show(),$('textarea[id="field-askaquestion'+a+'-message"]').val($('textarea[id="field-askaquestion'+a+'-message"]').html()),this.model.set("Notes",$('textarea[id="field-askaquestion'+a+'-message"]').val()))}if(this.settings.isHomeValue||i.attributes.IsHomeValue=="True"){var a="";this.cftype.indexOf("modal")!=-1&&(a="2"),$('textarea[id="field-requestashowing'+a+'-message"]').hide(),$('textarea[id="field-askaquestion'+a+'-message"]').show(),$('textarea[id="field-askaquestion'+a+'-message"]').val(""),$('textarea[id="field-message"]').val(""),$('textarea[id="field-askaquestion'+a+'-message"]').html(""),$('textarea[id="field-message"]').html(""),this.model.set("Notes",$('textarea[id="field-askaquestion'+a+'-message"]').val())}this.renderFirstTime=!0,HMSEvent.trigger("onContactFormRenderedComplete",this.cftype),new r.AgentView,setTimeout(function(){n.formFocusTrack()},2e3)},sendForm:function(t){var n=this;if(!t.get("email")||!t.get("email").match(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i))HMSEvent.trigger("ui-notify",{msg:"Type a valid email."});else{this.settings.AgentID&&t.set("AgentID",this.settings.AgentID);if(t.get("ContactFormType")=="getintouch"){var r=new e.Model;r.loadFromMData({el:".js-listitem"}),t.set("AgentID",r.get("AgentID"))}var i='.js-contactform[data-contactformtype="'+t.get("ContactFormType")+'"]';HMSEvent.trigger("ui-show-blocker",{element:i}),t.set("email",t.get("email").toLowerCase()),t.save(null,{success:function(e,t){HMSEvent.trigger("ui-hide-blocker",{element:i}),t.success==1?HMSEvent.trigger("ui-show-blocker",{element:i,msg:t.message,css:{width:"250px","text-align":"center"},overlay:{opacity:.8,cursor:"default","z-index":998}}):HMSEvent.trigger("ui-notify",{msg:t.message});var n=e.attributes.ContactFormType;e.attributes.HVListingID&&e.attributes.HVListingID!=""&&e.attributes.HVListingID!="0"&&(n=="requestshowing"||n=="moreinfo")&&(n="homevalueinquiry"),HMSEvent.trigger("TrackForm",{formid:n,status:"S"}),HMSEvent.trigger("ui-modal-close")}})}},switchMessages:function(e){e.preventDefault();var t=$(e.currentTarget),n="";this.cftype.indexOf("modal")!=-1&&(n="2"),$('textarea[id="field-askaquestion'+n+'-message"]').hide(),$('textarea[id="field-requestashowing'+n+'-message"]').hide(),$("#"+t.attr("id")+"-message").show(),$("#"+t.attr("id")+"-message").val($("#"+t.attr("id")+"-message").html()),this.model.set("Notes",$("#"+t.attr("id")+"-message").val())}});var u=null;return i.execute=function(e){o=!1,$(".js-contactform").each(function(t,n){new s.View({el:n,options:e})})},i.createsingleform=function(e,t){o=!1,new s.View({el:e,options:t})},i})