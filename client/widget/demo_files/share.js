define(["backbonestore","app/ui-modules/share/sendemailtofriend","app/models/user"],function(e,t,n){function u(){return HMSUser&&!HMSUser.isLoggedout()?!0:!1}var r={},i={},s="text!app/ui-modules/share/template/share.html",o="text!app/ui-modules/share/template/sharetext.html";return i.View=e.View.extend({events:{"click .js-share-email":"showSendEmailToFriend","click .js-share-handler":"checkLoggedIn","click .js-share-facebook":"shareListing","click .js-share-twitter":"shareListing","click .js-share-pinterest":"shareListing"},initialize:function(e){this.userReady=!1,this.settings=e,_.bindAll(this,"renderCallback","onUserReady","checkLoggedIn","showSendEmailToFriend","shareListing"),this.render(),HMSEvent.on("onUserReady",this.onUserReady,this),e.type=="text"?this.userReady=!0:HMSEvent.trigger("onShareReady"),$("body").bind("click",function(e){$(".js-sharelisting").removeClass("open")})},onUserReady:function(){this.userReady=!0},checkLoggedIn:function(e){e&&e.preventDefault();if(!this.userReady)return!1;if(!u())return HMSEvent.trigger("user-show-register",{callback:this.checkLoggedIn,args:e}),!1;$(".js-sharelisting").hasClass("open")||$(".js-sharelisting").addClass("open")},render:function(){var e=this.settings;e.type=="text"&&this.$el.data("url")?HMSTemplate.get(o,this.renderCallback):HMSTemplate.get(s,this.renderCallback)},renderCallback:function(t){var n=this,r=this.settings,i=r.sharetype,s=this.$el.data("listingid"),o=this.$el.data("searchtype"),u="",a=window.location.href,f=null,l=null;i=="search"&&(f="http://www.remax.com/resources/images/icons/large/balloon-color-191x258.png",l=$("h1").text().trim().replace(/\s+/g," "));if(i=="foreclosure"){var c=new e.Model;c.loadFromMData({el:".js-listitem"}),l=c.get("StreetName")+", "+c.get("City")+", "+c.get("State")+" "+c.get("Zip")}r.type=="text"&&this.$el.data("url")?(a="http://"+document.domain+this.$el.data("url"),u=t.render({ShareUrl:a,ListingID:s,sharetype:i,searchtype:o,shareimg:f,sharemsg:l})):(this.$el.data("url")&&(a="http://"+document.domain+this.$el.data("url")),u=t.render({ShareUrl:a,ListingID:s,sharetype:i,searchtype:o,shareimg:f,sharemsg:l})),this.$el.replaceWith(u);var h="";s&&(h='[data-listingid="'+s+'"]'),this.setElement(".js-sharelisting"+h),$.ajax({url:"http://w.sharethis.com/button/buttons.js",dataType:"script",success:function(){var e=!0;stLight.options({publisher:"ur-28415ced-cde1-fee1-c137-39a04dfde752",onhover:!1}),stLight.onDomContentLoadedLazy()},cache:!0})},showSendEmailToFriend:function(e){this.shareListing(e);var n=null;e&&e.currentTarget&&(n=$(e.currentTarget)),t.showModal(n.data())},shareListing:function(e){if(HMSUser.isUserReady){var t=$(e.currentTarget),r=null,i=null;i=parseInt(t.data("listingid"),0);var s=null;s=t.data("sharetype"),i>0||(i=parseInt(t.parent().data("listingid"),0)),i>0||(i=parseInt(t.parent().parent().data("listingid"),0));if(isNaN(i)||i==0){var o=$(".js-listitem");r=new n.HVShareListing({},{siteid:"68000000"}),r.loadFromMData({el:o}),i=parseInt(r.get("HVListingID")),i>0&&r.set("ListingID",i)}if(isNaN(i)||i==0)i=parseInt(t.data("hvlistingid"),0),i>0&&r.set("ListingID",i);if(HMSUser.isLoggedout())HMSEvent.trigger("user-show-register",{action:"sharelisting",ListingID:i});else if(i>0){var u=1;s&&s=="foreclosure"&&(u=3),r||(r=new n.ShareListing({ListingID:i},{siteid:"68000000",sharedListingTypeID:u})),r.save()}}}}),r=i,r})