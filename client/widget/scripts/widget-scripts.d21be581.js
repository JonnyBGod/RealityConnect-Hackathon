var ObjectId=function(){function a(){return this instanceof ObjectId?void("object"==typeof arguments[0]?(this.timestamp=arguments[0].timestamp,this.machine=arguments[0].machine,this.pid=arguments[0].pid,this.increment=arguments[0].increment):"string"==typeof arguments[0]&&24==arguments[0].length?(this.timestamp=Number("0x"+arguments[0].substr(0,8)),this.machine=Number("0x"+arguments[0].substr(8,6)),this.pid=Number("0x"+arguments[0].substr(14,4)),this.increment=Number("0x"+arguments[0].substr(18,6))):4==arguments.length&&null!=arguments[0]?(this.timestamp=arguments[0],this.machine=arguments[1],this.pid=arguments[2],this.increment=arguments[3]):(this.timestamp=Math.floor((new Date).valueOf()/1e3),this.machine=d,this.pid=c,this.increment=b++,b>16777215&&(b=0))):new ObjectId(arguments[0],arguments[1],arguments[2],arguments[3]).toString()}var b=0,c=Math.floor(32767*Math.random()),d=Math.floor(16777216*Math.random());if("undefined"!=typeof localStorage){var e=parseInt(localStorage.mongoMachineId);e>=0&&16777215>=e&&(d=Math.floor(localStorage.mongoMachineId)),localStorage.mongoMachineId=d,document.cookie="mongoMachineId="+d+";expires=Tue, 19 Jan 2038 05:00:00 GMT"}else{var f=document.cookie.split("; ");for(var g in f){var h=f[g].split("=");if("mongoMachineId"==h[0]&&h[1]>=0&&h[1]<=16777215){d=h[1];break}}document.cookie="mongoMachineId="+d+";expires=Tue, 19 Jan 2038 05:00:00 GMT"}return a}();ObjectId.prototype.getDate=function(){return new Date(1e3*this.timestamp)},ObjectId.prototype.toArray=function(){var a,b=this.toString(),c=[];for(a=0;12>a;a++)c[a]=parseInt(b.slice(2*a,2*a+2),16);return c},ObjectId.prototype.toString=function(){var a=this.timestamp.toString(16),b=this.machine.toString(16),c=this.pid.toString(16),d=this.increment.toString(16);return"00000000".substr(0,8-a.length)+a+"000000".substr(0,6-b.length)+b+"0000".substr(0,4-c.length)+c+"000000".substr(0,6-d.length)+d},function(a){a.countLines=function(b,c){var d={recalculateCharWidth:!0,charsMode:"random",fontAttrs:["font-family","font-size","text-decoration","font-style","font-weight"]};c=a.extend({},d,c);var e,f="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";b.jquery||(b=a(b));var g=b.val();switch(c.charsMode){case"random":for(c.chars="",f+=".,?!-+;:'\"",e=1;12>=e;e++)c.chars+=f[Math.floor(Math.random()*f.length)];break;case"alpha":c.chars=f;break;case"alpha_extended":c.chars=f+".,?!-+;:'\"";break;case"from_ta":if(g.length<15)c.chars=f;else for(e=1;15>=e;e++)c.chars+=g[Math.floor(Math.random()*g.length)];break;case"custom":}a.isArray(c.chars)||(c.chars=c.chars.split(""));var h="";for(e=1;10>=e;e++)h+=Math.floor(10*Math.random())+1;b.after("<span id='s"+h+"'></span>");var i=a("#s"+h);i.hide(),a.each(c.fontAttrs,function(a,c){i.css(c,b.css(c))});var j,k=g.split("\n"),l=k.length;if(c.recalculateCharWidth||null==b.data("average_char")){var m=c.chars,n=m.length,o=0;a.each(m,function(a,b){i.text(b),o+=i.width()}),b.data("average_char",Math.ceil(o/n))}j=b.data("average_char"),i.remove();var p,q=2*(b.outerWidth()-b.width()),r=0,s=0,t=0;a.each(k,function(c,d){if(p=(d.length+1)*j+q,p>=b.outerWidth()){var e=Math.floor(p/b.outerWidth());s+=e,r++}""===a.trim(d)&&t++});var u={};return u.actual=l,u.wrapped=r,u.wraps=s,u.visual=l+s,u.blank=t,u}}(jQuery),angular.module("ori",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ngRoute","lbServices","services","directives","pascalprecht.translate","angulartics","angulartics.google.tagmanager"]).config(["$locationProvider",function(a){a.html5Mode(!0).hashPrefix("!")}]).config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:"locales/en.",suffix:".json"}),a.preferredLanguage("en-GB"),a.useLocalStorage()}]).config(["$analyticsProvider",function(a){a.settings.trackRelativePath=!0}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"homeCtrl",resolve:{app:["$route","App",function(a,b){return b.findById({id:a.current.params.apiKey},function(a){return a},function(){return null})}],owner:["$route","User",function(a,b){return b.findOne({filter:{where:{or:[{phone:a.current.params.t_i},{email:a.current.params.t_i}]}}},function(a){return a},function(){return null})}]}}).otherwise({redirectTo:"/"})}]).run(["AppAuth","User","LoopBackAuth",function(a,b,c){a.ensureHasCurrentUser(b),Visibility.change(function(d,e){"visible"===e&&(c.currentUserId=localStorage.$LoopBack$currentUserId||sessionStorage.$LoopBack$currentUserId||null,c.accessTokenId=localStorage.$LoopBack$accessTokenId||sessionStorage.$LoopBack$accessTokenId||null,a.ensureHasCurrentUser(b))})}]),angular.module("services",["lbServices"]).factory("AppAuth",["$rootScope","$location","LoopBackAuth","$window",function(a,b,c,d){return{currentUser:{},ensureHasCurrentUser:function(b){if(this.currentUser&&this.currentUser.id){if(!c.currentUserId||!c.accessTokenId)return this.logout(b)}else if(c.currentUserId&&c.accessTokenId){var d=this;d.currentUser=b.getCurrent(function(b){d.currentUser.chatRooms=[],a.$broadcast("login",b.username)},function(a){console.log(a)})}},logout:function(a){var e=this;a.logout(function(){e.currentUser=null,c.currentUserId="",c.accessTokenId="",c.rememberMe=!0,c.save(),b.path("/"),d.location.reload()},function(a){a&&"could not find accessToken"===a.data.error.message&&(e.currentUser=null,c.currentUserId="",c.accessTokenId="",c.rememberMe=!0,c.save(),b.path("/"),d.location.reload())})}}}]).factory("iframe",["$rootScope",function(a){function b(a){return a.hash.slice(1).replace(/(^\d+).*/,"$1")}function c(a){var b=a.split("/");return b[0]+"//"+b[2]}var d=b(window.location),e=window.opener||window.parent,f=document.referrer,g={};g.client=c(document.location.href),g.host=f?c(f):g.client;var h={getUID:b,origins:g,messageHandler:function(b){b=b.originalEvent;var c;try{c=JSON.parse(b.data)}catch(d){return}if(!c.name||"!"!==c.name[0]||b.origin===g.client)switch(c.scope){case"host":break;case"client":a.$broadcast(c.name,c.data)}},postMessage:function(a){a.sender=d,a=JSON.stringify(a),e.postMessage(a,"*")},sendHostMessage:function(a,b){b=b||[],h.postMessage({scope:"host",name:a,data:b})}};return $(window).on("message",h.messageHandler),$(window).on("unload",function(){h.sendHostMessage("die")}),h}]).factory("socket",["$rootScope","LoopBackAuth","AppAuth",function(a,b,c){return{socket:!1,connect:function(){var a=this;a.socket||(a.socket=io("/",{query:"access_token="+b.accessTokenId}),a.on("connection",function(){console.log("connect")}),a.on("connection_error",function(){console.log("connect_error")}),a.on("chat",function(a){if(console.log("chat",a),"startConversation"===a.type){var b=c.currentUser.chatRooms.filter(function(b){return b.id===a.chatRoom.id});if(b.length)for(var d=0;d<a.chatRoom.users.length;d++)b[0].users.filter(function(b){return b.id===a.chatRoom.users[d].id}).length||b[0].users.push(a.chatRoom.users[d]);else a.chatRoom.noMore=!0,a.chatRoom.events||(a.chatRoom.events=[]),c.currentUser.chatRooms.push(a.chatRoom);a=a.event||a.events}Array.isArray(a)||(a=[a]);for(var e=0;e<a.length;e++)for(var f=c.currentUser.chatRooms.length-1;f>=0;f--)if(c.currentUser.chatRooms[f].id===a[e].chatRoom||a[e].chatRooms&&-1!==a[e].chatRooms.indexOf(c.currentUser.chatRooms[f].id))if(-1!==a[e].type.indexOf("update"))if("update:seen"===a[e].type)c.currentUser.chatRooms[f].seen?c.currentUser.chatRooms[f].seen.filter(function(b){return b.user===a[e].seen.user}).length?c.currentUser.chatRooms[f].seen.filter(function(b){return b.user===a[e].seen.user})[0].date=a[e].seen.date:c.currentUser.chatRooms[f].seen.push(a[e].seen):c.currentUser.chatRooms[f].seen=[a[e].seen];else for(var d=c.currentUser.chatRooms[f].users.length-1;d>=0;d--)c.currentUser.chatRooms[f].users[d].id===a[e].sender&&("update:writting"===a[e].type?c.currentUser.chatRooms[f].users[d].writting=!0:"update:stoppedWritting"===a[e].type&&(c.currentUser.chatRooms[f].users[d].writting=!1));else c.currentUser.chatRooms[f].events.push(a[e])}))},on:function(b,c){var d=this;d.socket.on(b,function(){var b=arguments;a.$apply(function(){c.apply(d.socket,b)})})},emit:function(b,c,d){var e=this;e.socket.emit(b,c,function(){var b=arguments;a.$apply(function(){d&&d.apply(e.socket,b)})})},json:{send:function(b,c){var d=this;d.socket.json.send(b,function(){var b=arguments;a.$apply(function(){c&&c.apply(d.socket,b)})})}}}}]),angular.module("directives",[]).directive("caasTime",function(){return{link:function(a,b,c){return moment.locale("en"),b.text(moment(new Date(1e3*parseInt(c.caasTime.toString().slice(0,8),16))).calendar())}}}).directive("caasTimeStamp",function(){return{link:function(a,b,c){return moment.locale("en"),b.text(moment(new Date(1e3*parseInt(c.caasTimeStamp.toString().slice(0,8),16))).format("LT"))}}}).directive("whenScrolledChat",["$timeout",function(a){return function(b,c,d){var e=c[0],f=!1;c.bind("scroll",function(){f&&(f=!1),!b.forceScrollReset&&!b.loading&&e.scrollTop<=100?(f=e.scrollHeight,b.$apply(d.whenScrolledChat).then(function(){a(function(){f&&(e.scrollTop=e.scrollHeight-f)})})):e.scrollTop+e.clientHeight===e.scrollHeight&&(!b.currentChatRoom.seen||!b.currentChatRoom.seen.filter(function(a){return a.user===b.currentUser.id}).length||new Date(b.currentChatRoom.seen.filter(function(a){return a.user===b.currentUser.id})[0].date)<new Date(1e3*parseInt(b.currentChatRoom.events[b.currentChatRoom.events.length-1].id.toString().slice(0,8),16)))&&(b.updateSeen(),b.$apply())})}}]).directive("whenScrolled",["$timeout",function(){return function(a,b,c){var d=b[0];b.bind("scroll",function(){!a.currentChatRoom.loadingFiles&&d.scrollHeight-d.scrollTop<=d.clientHeight+100&&a.$apply(c.whenScrolled)})}}]).directive("seenSrc",function(){return{link:function(a,b){return b.attr("src",a.currentChatRoom.users.filter(function(b){return b.id===a.seen.user})[0].photo||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIj48cmVjdCB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjcwIiB5PSI3MCIgc3R5bGU9ImZpbGw6I2FhYTtmb250LXdlaWdodDpib2xkO2ZvbnQtc2l6ZToxMnB4O2ZvbnQtZmFtaWx5OkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmO2RvbWluYW50LWJhc2VsaW5lOmNlbnRyYWwiPjE0MHgxNDA8L3RleHQ+PC9zdmc+")}}}).directive("photoSrc",function(){return{link:function(a,b){var c=a.currentChatRoom.users.filter(function(b){return b.id===a.event.sender})[0]||a.currentChatRoom.oldUsers.filter(function(b){return b.id===a.event.sender})[0];return b.attr("src",c.photo||a.params.t_p||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAiIGhlaWdodD0iMTQwIj48cmVjdCB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjcwIiB5PSI3MCIgc3R5bGU9ImZpbGw6I2FhYTtmb250LXdlaWdodDpib2xkO2ZvbnQtc2l6ZToxMnB4O2ZvbnQtZmFtaWx5OkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmO2RvbWluYW50LWJhc2VsaW5lOmNlbnRyYWwiPjE0MHgxNDA8L3RleHQ+PC9zdmc+")}}}).directive("imageSrc",["$timeout",function(a){return{link:function(b,c,d){a(function(){var a=c.width(),b=c.height();-1===d.imageSrc.indexOf("http")&&(d.imageSrc="http:"+d.imageSrc);for(var e=0;e<photoSizesWidths.length;e++)if(photoSizesWidths[e]<a){for(var f=0;f<photoSizesHeights.length;f++)if(photoSizesHeights[f]<b){var g=(photoSizesWidths[e-1]?photoSizesWidths[e-1]:photoSizesWidths[e])+"x"+(photoSizesHeights[f-1]?photoSizesHeights[f-1]:photoSizesHeights[f]);c.attr("src","//d10nrrb1q7v7qu.cloudfront.net/"+encodeURL(CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA1("trim/"+g+"/smart/"+d.imageSrc,"qwerty")))+"/trim/"+g+"/smart/"+d.imageSrc),f=photoSizesHeights.length+1}e=photoSizesWidths.length+1}},0)}}}]).directive("arrowBackground",function(){return{link:function(a,b,c){b.append("<style scoped>"+c.arrowBackground+"</style>"),c.$observe("arrowBackground",function(){b.children("style").remove(),b.append("<style scoped>"+c.arrowBackground+"</style>")})}}}),angular.module("ori").controller("homeCtrl",["$scope","User","ChatRoom","$location","AppAuth","app","owner","iframe","$routeParams","$timeout","$q",function(a,b,c,d,e,f,g,h,i,j,k){a.currentUser=e.currentUser,a.params=i,a.showForm=!1,a.ShowRegisterForm=!1,a.data={},a.success=!1,a.error=!1,a.formData={},a.logout=function(){e.logout(b)},k.all([f,g]).then(function(b){a.app=b[0],a.owner=b[1],a.currentUser.id&&!a.currentChatRoom&&a.getChatRoom(),j(function(){a.owner.email&&a.owner.email===a.params.o_e&&a.app?(h.sendHostMessage("ready"),h.sendHostMessage("mainViewRendered",{height:$("body").height()})):(h.sendHostMessage("fail"),h.sendHostMessage("mainViewRendered",{height:$("body").height()}))},0)}),a.getChatRoom=function(){var c=document.createElement("a");c.href=a.params.t_u,b.prototype$getChatRoom({id:a.currentUser.id,filter:{owner:a.owner.id,appId:a.app.id,appUrl:c.pathname+c.search}},function(b){e.currentUser.chatRooms=[b.chatRoom],a.currentChatRoom=e.currentUser.chatRooms[0],j(function(){h.sendHostMessage("resize",{height:$("body").height()})},100)},function(){e.currentUser.chatRooms=[],a.currentChatRoom=!1,j(function(){h.sendHostMessage("resize",{height:$("body").height()})},100)})},a.$on("login",function(b,c){if(a.currentUser=e.currentUser,c){var d=screen.availHeight/2-242,h=screen.availWidth/2-410;return e.popupWin=window.open("/widget/auth/","imoglobe","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=500, height=420, top="+d+", left="+h)}e.popupWin&&e.popupWin.close(),a.$watchCollection("currentUser.chatRooms",function(){e.currentUser.chatRooms.length&&(a.currentChatRoom=e.currentUser.chatRooms[0])}),a.owner.id&&a.app.id?a.getChatRoom():k.all([f,g]).then(function(){j(function(){a.owner.id&&a.app.id&&a.getChatRoom()},100)})}),a.openAuth=function(a){if(a.length){var b=screen.availHeight/2-242,c=screen.availWidth/2-410;!e.popupWin||e.popupWin.closed?e.popupWin=window.open("/../widget-auth/"+a,"imoglobe","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=800, height=600, top="+b+", left="+c):e.popupWin.focus()}else{var b=screen.availHeight/2-242,c=screen.availWidth/2-410;!e.popupWin||e.popupWin.closed?e.popupWin=window.open("/widget/auth/","imoglobe","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=500, height=420, top="+b+", left="+c):e.popupWin.focus()}},a.toggleShowForm=function(){a.showForm=!0,setTimeout(function(){h.sendHostMessage("resize",{height:$("body").height()})})},a.toggleShowRegisterForm=function(){a.ShowRegisterForm=!0,setTimeout(function(){h.sendHostMessage("resize",{height:$("body").height()})})},a.startConversation=function(){b.prototype$startConversation({id:e.currentUser.id},{users:[a.owner.id],appId:f.id,appUrl:a.params.t_u,event:{type:"message",text:a.data.message}},function(){a.getChatRoom()},function(){})},a.login=function(){a.loading=!0,a.loginResult=b.login({include:"user apps",rememberMe:!0},a.formData,function(){a.loading=!1,e.currentUser=a.loginResult.user},function(b){a.loading=!1,a.loginError=b.data.error})},a.register=function(){a.loading=!0,a.user=b.save(a.formData,function(){a.loading=!1,a.login()},function(b){a.loading=!1,a.registerError=b.data.error})}}]).controller("chatCtrl",["$scope","socket","$timeout","$window","User","$q","ChatRoom",function(a,b,c,d,e,f,g){b.connect(),a.forceScrollReset=!0,a.getChatRoomEvents=function(){var b=f.defer();if(a.currentChatRoom.loading||!a.currentChatRoom||a.currentChatRoom.noMore)b.reject();else{a.currentChatRoom.loading=!0;var c=a.currentChatRoom.id;g.prototype$__get__event({id:c,filter:{where:{users:a.currentUser.id},order:"id DESC",skip:a.currentChatRoom.events.length,limit:10}},function(d){var e=a.currentUser.chatRooms.filter(function(a){return a.id===c})[0];e.loading=!1,d.length<10&&(e.noMore=!0),d.length&&!e.events.filter(function(a){return a.id===d[0].id}).length&&([].push.apply(d.reverse(),e.events),e.events=d),b.resolve()},function(){var b=a.currentUser.chatRooms.filter(function(a){return a.id===c})[0];b.loading=!1})}return b.promise},a.$watchCollection("currentChatRoom.events",function(b,d){b&&d&&c(function(){var e=document.getElementById("chat");b.length>d.length&&("auto"===e.style.top||e.scrollTop+e.clientHeight===e.scrollHeight)&&a.currentChatRoom&&(!a.currentChatRoom.seen||!a.currentChatRoom.seen.filter(function(b){return b.user===a.currentUser.id}).length||new Date(a.currentChatRoom.seen.filter(function(b){return b.user===a.currentUser.id})[0].date)<new Date(1e3*parseInt(a.currentChatRoom.events[a.currentChatRoom.events.length-1].id.toString().slice(0,8),16)))&&(a.updateSeen(),a.$apply()),a.checkSize(),(d&&d.length<2||a.forceScrollReset||e.clientHeight+e.scrollTop+60>=e.scrollHeight||!b[b.length-1].sender)&&(c(function(){e.scrollTop=e.scrollHeight}),a.forceScrollReset&&c(function(){a.forceScrollReset=!1},100))},0)}),a.checkSize=function(){var b=document.getElementById("chat");b.scrollHeight<=b.clientHeight&&b.clientHeight<=$("body").innerHeight()-146?(b.style.top="auto",a.currentChatRoom.noMore||a.getChatRoomEvents().then(function(){c(function(){a.forceScrollReset=!0})})):(b.style.top=0,a.currentChatRoom.initialLoading=!0)},a.$watch("currentChatRoom.seen",function(b){if(b){for(var c=0;c<a.currentChatRoom.events.length;c++)a.currentChatRoom.events[c].seen&&(a.currentChatRoom.events[c].seen=null);for(var c=0;c<b.length;c++)if(b[c].user!==a.currentUser.id)for(var d=!1,e=a.currentChatRoom.events.length-1;e>=0;e--)!d&&new Date(b[c].date)>new Date(1e3*parseInt(a.currentChatRoom.events[e].id.toString().slice(0,8),16))&&(a.currentChatRoom.events[e].seen?a.currentChatRoom.events[e].seen.push(b[c]):a.currentChatRoom.events[e].seen=[b[c]],d=!0)}},!0),d.onfocus=function(){var b=document.getElementById("chat");("auto"===b.style.top||b.scrollTop+b.clientHeight===b.scrollHeight)&&a.currentChatRoom&&(!a.currentChatRoom.seen||!a.currentChatRoom.seen.filter(function(b){return b.user===a.currentUser.id}).length||a.currentChatRoom.events.length&&new Date(a.currentChatRoom.seen.filter(function(b){return b.user===a.currentUser.id})[0].date)<new Date(1e3*parseInt(a.currentChatRoom.events[a.currentChatRoom.events.length-1].id.toString().slice(0,8),16)))&&(a.updateSeen(),a.$apply())},$(".home > .view").addClass("chatRoom"),a.$on("$destroy",function(){$(".home > .view").removeClass("chatRoom"),d.onfocus=function(){}}),a.updateSeen=function(){if(a.currentChatRoom.seen){var c=a.currentChatRoom.seen.filter(function(b){return b.user===a.currentUser.id});if(c.length)c=c[0],c.date=new Date;else{var c={user:a.currentUser.id,date:new Date};a.currentChatRoom.seen.push(c)}}else{var c={user:a.currentUser.id,date:new Date};a.currentChatRoom.seen=[c]}b.emit("chat",{chatRoom:a.currentChatRoom.id,seen:c,type:"update:seen"})},a.chatBoxFocus=function(){console.log("focus")},a.chatDblClick=function(){console.log("dblClick")},c(function(){var a=document.getElementById("chat");a.scrollTop=a.scrollHeight})}]).controller("chatFooterCtrl",["$scope","socket","$timeout","$window","User","ChatRoom",function(a,b,c,d,e){a.menu=!1,a.menuPhoto=!1,a.menuVideo=!1,a.menuLocation=!1,a.menuAttach=!1,a.sendMessage=function(){var b={chatRoom:a.currentChatRoom.id,type:"message",text:a.currentChatRoom.message.text};(!a.currentChatRoom.events.length||Math.floor((new Date-new Date(1e3*parseInt(a.currentChatRoom.events[a.currentChatRoom.events.length-1].id.toString().slice(0,8),16)))/6e4)>60)&&(b.startSession=!0);var d=ObjectId().toString();e.events.create({id:a.currentUser.id},b,function(b){for(var c=0;c<a.currentChatRoom.events.length;c++)a.currentChatRoom.events[c].id===d&&(a.currentChatRoom.events[c]=b)},function(a){console.error(a)}),c(function(){b.id=d,a.currentChatRoom.events.push(b),a.currentChatRoom.message.text="",a.currentChatRoom.message.url=!1,$("#chatBox").removeClass("expanded")},0)},a.updateChatBox=function(){var c=$.countLines("#chatBox");if(c.actual>1){$("#chatView").addClass("expandedChatBox");var d=document.getElementById("chat");d.style.top=d.scrollHeight<=d.clientHeight&&d.clientHeight<=$("body").innerHeight()-146?"auto":0,d.clientHeight+d.scrollTop+16===d.scrollHeight&&(d.scrollTop=d.scrollHeight)}else $("#chatView").removeClass("expandedChatBox");!a.writting&&a.currentChatRoom.message.text.length?(a.writting=!0,b.emit("chat",{chatRoom:a.currentChatRoom.id,type:"update:writting"})):a.writting&&!a.currentChatRoom.message.text.length&&(a.writting=!1,b.emit("chat",{chatRoom:a.currentChatRoom.id,type:"update:stoppedWritting"}))},a.clearMessageUrl=function(){a.currentChatRoom.message.url=!1},a.send=function(){a.currentChatRoom.message.text.length&&a.sendMessage()},a.chatBoxKeydown=function(b){if(13!==b.which||b.shiftKey){if(13===b.which&&b.shiftKey){var c=$.countLines("#chatBox");(c.actual=1)&&$("#chatView").addClass("expandedChatBox")}}else a.send(),b.preventDefault()}}]);