function HMSEventSRPMapReady(){HMSEvent.trigger("map-api-loaded")}function HMSEventMiniMapReady(){HMSEvent.trigger("mini-map-api-loaded")}function BringInfoBoxToFront(){$(".js-map-infobox").parent().parent().parent().css("z-index","2000"),setTimeout(function(){$(".js-map-infobox").parent().parent().parent().css("z-index","2000")},10),setTimeout(function(){$(".js-map-infobox").parent().parent().parent().css("z-index","2000")},100)}define(["backbonestore","app/models/search","app/ui-modules/tabs/base","app/shared/views/compliance","app/shared/views/branding","app/ui-modules/images/imageloader","app/mediators/form","hmsglobal","app/demographics/demographics","app/homevalue/models","app/ui-modules/miraclehome/view"],function(e,t,n,r,i,s,o,u,a,f,l){function C(){N||(N=new l.MiracleView),N.render()}function k(){$.each(arrPending,function(e,t){t&&t.abort&&t.abort()})}var c="text!templates/listings/results-map-list-item.html",h="text!templates/listings/results-map-fclist-item.html",p="text!templates/listings/results-map-info.html",d="text!templates/listings/results-map-cluster.html",v="text!templates/listings/results-map-poicluster.html",m="text!templates/listings/results-map-rscluster.html",g="text!templates/listings/results-map-poiinfo.html",y="text!templates/listings/results-map-rsinfo.html",b="text!templates/listings/results-map-fcinfo.html",w="text!templates/listings/results-map-fccluster.html",E={},S={},x=!1,T=!1;E.Map=e.View.extend({model:new t.Search,collection:new t.Listings,foreclosures:new t.Foreclosures,name:"js-map-listing-results",el:".js-map-listing-results",settings:{},maxcount:250,location:$("#js-refinesearch").find("#location").val(),centerLat:0,centerLong:0,bounds:null,isSideClicked:!1,_counter:1e3,currentPin:null,dataInfo:[],pinLocation:{},isEmptyMsg:!1,isEmpty:!1,blockKeys:{},events:{"change #js-update-amenities":"updateAmenities","change #js-update-recent-sales":"updateRecentSales","click .js-map-tabs li a":"onclickMapTab"},defaultCursor:null,maplids:[],mapfcids:[],lisPageCount:50,listingsMaxCount:1e3,getMoreListItemsFired:!1,getMoreFCListItemsFired:!1,loadedListings:[],loadedForeclosures:[],loadedIDs:[],loadedFCIDs:[],gridSize:25,itemClicked:0,fcitemClicked:0,modelMapTab:new e.Model,activeLayer:"listingsClusteredLayer",initialize:function(e){k(),this.router=e,_.bindAll(this,"loadApi","isLoaded","query","mapReady","render","renderMap","createMap","getBounds","getCenter","setCenter","mapChange","show","hide","createPin","createClusteredPin","blockMap","unblockMap","onRemoveListing","centerInfobox","hidePinInfobox","showPinInfobox","onMapZoom","onMouseUp","updateAmenities","getAmenities","addAmenities","hideAmenities","showAmenities","createAmenityPin","createAmenityClusteredPin","updateRecentSales","getRecentSales","addRecentSales","hideRecentSales","showRecentSales","createRecentSalePin","createRecentSaleClusteredPin","getLoadedListing","getPin","getMoreListItems","onViewChangeEnd","onViewChangeStart","getListings","getForeclosures","addListings","addForeclosures","createForeclosurePin","createForeclosureClusteredPin","getLoadedForeclosure","getMoreFCListItems","onclickMapTab","onMapTabChange","BringActiveLayerToFront","updateSearchResults","reloadMap"),this.modelMapTab.on("change",this.onMapTabChange),this.elMapHolder=this.$el.find("#js-map-container").get(0),this.key=$(".js-mapsearch").attr("data-key"),this.collection.parentName=this.name,this.brandingView=new i.Office({collection:this.collection}),this.disclosureView=new r.Disclosure({selector:".js-listitem",collection:this.collection}),HMSEvent.on("location-complete",this.setCenter),HMSEvent.on("remove-map-listing",this.onRemoveListing),$.cookie("showAmenities")=="true"?$("#js-update-amenities")[0].checked=!0:$("#js-update-amenities")[0].checked=!1,$.cookie("showRecentSales")=="true"?$("#js-update-recent-sales")[0].checked=!0:$("#js-update-recent-sales")[0].checked=!1,HMSEvent.on("user-refresh-hidelisting",this.reloadMap),HMSEvent.on("user-foreclosure-reloadpage",this.reloadMap),HMSEvent.on("user-foreclosure-logout",this.reloadMap)},reloadMap:function(){this.router.tabsView.active=="map"&&this.router.execSearch("tab-map")},updateSearchResults:function(e){var t=this.router.searchResultsPageView.model.toJSON();_.extend(t,e),t.ForSaleHeader=!1,t.RecentHeader=!1,t.ForeclosuresHeader=!1,t.searchLocation=t.location,t.type=="listing"&&(t.ForSaleHeader=!0,t.showmlsselector=!0),t.type=="foreclosure"&&(t.ForeclosuresHeader=!0),this.router.searchView.updateHeaderResults(t),this.router.searchView.updateRefineSearch(t)},BringActiveLayerToFront:function(){this[this.activeLayer]&&this[this.activeLayer].BringLayerToFront()},onclickMapTab:function(e){e.preventDefault(),e&&e.currentTarget&&(this.modelMapTab.set("tab",$(e.currentTarget).data("name")),this.modelMapTab.set("clickedActiveTab",$(e.currentTarget).data("name")),this.hidePinInfobox())},onMapTabChange:function(e){var t=$(".js-map-tabs li a");t.removeClass("active");var n=$('.js-map-tabs li a[data-name="'+e.get("tab")+'"]');n.addClass("active"),n[0].hash=="#js-map-listings"&&this.listItems.show(),n[0].hash=="#js-map-foreclosures"&&this.listFCItems.show()},createPinInfobox:function(){var e={width:388,height:300,showCloseButton:!1,zIndex:1e3,offset:new Microsoft.Maps.Point(0,0),showPointer:!1,visible:!1};this.pinInfobox=new Microsoft.Maps.Infobox(0,e),this.pinInfobox.setHtmlContent('<div class="js-map-infobox"  style="width:388px;height:300px">.</div>'),this.entityCollectionInfoBox=new Microsoft.Maps.EntityCollection({zIndex:2e3}),this.entityCollectionInfoBox.push(this.pinInfobox),this.entityCollectionInfoBox.keepLayerOnTop=!0,this.map.entities.push(this.entityCollectionInfoBox)},updateAmenities:function(e){$.cookie("showAmenities",e.currentTarget.checked,{path:"/"}),e.currentTarget.checked?this.showAmenities():this.hideAmenities()},getAmenities:function(e){this.blockMap("a");if(!e){var t=this.map.getBounds(),n,r,i,s;t.getNorth()>this.originalBounds.getNorth()?n=this.originalBounds.getNorth()+.005:n=t.getNorth(),t.getEast()>this.originalBounds.getEast()?r=this.originalBounds.getEast()+.005:r=t.getEast(),t.getSouth()<this.originalBounds.getSouth()?i=this.originalBounds.getSouth()-.005:i=t.getSouth(),t.getWest()<this.originalBounds.getWest()?s=this.originalBounds.getWest()-.005:s=t.getWest()}this.poiCollection||(this.poiCollection=new a.POICollection),this.poiCollection.params.maxcount=this.listingsMaxCount,this.poiCollection.params.mappois=!0,this.poiCollection.params.lat=this.centerLat,this.poiCollection.params.long=this.centerLong,e?(this.poiCollection.params.nelat=e[0],this.poiCollection.params.nelong=e[3],this.poiCollection.params.swlat=e[2],this.poiCollection.params.swlong=e[1]):(this.poiCollection.params.nelat=n,this.poiCollection.params.nelong=r,this.poiCollection.params.swlat=i,this.poiCollection.params.swlong=s);var o;return e?o=this.poiCollection.fetch():o=this.poiCollection.fetch({success:this.addAmenities}),arrPending.push(o),o},addAmenities:function(e){this.amenitiesClusteredLayer=new ClusteredEntityCollection(this.map,{singlePinCallback:this.createAmenityPin,clusteredPinCallback:this.createAmenityClusteredPin,clusteringEnabled:!0,gridSize:this.gridSize,visible:!0}),this.poiCollection&&this.poiCollection.models.length>0&&$.each(this.poiCollection.models,function(e,t){t.set("PointOfInterestType",t.get("Type")),t.set("POITypeID",t.get("TpID")),t.set("Latitude",t.get("Lat")),t.set("Longitude",t.get("Lng")),t.set("Address",t.get("Addr"))}),this.amenitiesClusteredLayer.SetData(this.poiCollection.toJSON()),this.BringActiveLayerToFront(),this.entityCollectionInfoBox&&this.entityCollectionInfoBox.setOptions({zIndex:2e3}),this.unblockMap("a")},showAmenities:function(){this.amenitiesClusteredLayer?this.amenitiesClusteredLayer.setOptions({visible:!0}):(this.getAmenities(),this.BringActiveLayerToFront()),this.hidePinInfobox(!0)},hideAmenities:function(){this.amenitiesClusteredLayer&&this.amenitiesClusteredLayer.setOptions({visible:!1}),this.hidePinInfobox(!0)},updateRecentSales:function(e){$.cookie("showRecentSales",e.currentTarget.checked,{path:"/"}),e.currentTarget.checked?this.showRecentSales():this.hideRecentSales()},showRecentSales:function(){this.recentSalesClusteredLayer?this.recentSalesClusteredLayer.setOptions({visible:!0}):(this.getRecentSales(),this.BringActiveLayerToFront()),this.hidePinInfobox(!0)},hideRecentSales:function(){this.recentSalesClusteredLayer&&this.recentSalesClusteredLayer.setOptions({visible:!1}),this.hidePinInfobox(!0)},getRecentSales:function(e){this.blockMap("rs");if(!e){var t=this.map.getBounds(),n,r,i,s;t.getNorth()>this.originalBounds.getNorth()?n=this.originalBounds.getNorth()+.005:n=t.getNorth(),t.getEast()>this.originalBounds.getEast()?r=this.originalBounds.getEast()+.005:r=t.getEast(),t.getSouth()<this.originalBounds.getSouth()?i=this.originalBounds.getSouth()-.005:i=t.getSouth(),t.getWest()<this.originalBounds.getWest()?s=this.originalBounds.getWest()-.005:s=t.getWest()}this.rsCollection||(this.rsCollection=new f.NearByListings),this.rsCollection.attributes||(this.rsCollection.attributes={}),this.rsCollection.attributes.days=1095,this.rsCollection.attributes.nometadata=!0,this.rsCollection.attributes.forcemaxcount=!0,this.rsCollection.attributes.Count=this.listingsMaxCount,this.rsCollection.attributes.maplistings=1,e?(this.rsCollection.attributes.toplat=e[0],this.rsCollection.attributes.botlon=e[3],this.rsCollection.attributes.botlat=e[2],this.rsCollection.attributes.toplon=e[1]):(this.rsCollection.attributes.toplat=n,this.rsCollection.attributes.botlon=r,this.rsCollection.attributes.botlat=i,this.rsCollection.attributes.toplon=s);var o;return e?o=this.rsCollection.fetch():o=this.rsCollection.fetch({success:this.addRecentSales}),arrPending.push(o),o},addRecentSales:function(e){this.recentSalesClusteredLayer=new ClusteredEntityCollection(this.map,{singlePinCallback:this.createRecentSalePin,clusteredPinCallback:this.createRecentSaleClusteredPin,clusteringEnabled:!0,gridSize:this.gridSize,visible:!0}),this.rsCollection&&this.rsCollection.models.length>0&&$.each(this.rsCollection.models,function(e,t){t.set("sz_id",t.get("i")),t.set("Latitude",t.get("a")),t.set("Longitude",t.get("o"))}),this.recentSalesClusteredLayer.SetData(this.rsCollection.toJSON()),this.BringActiveLayerToFront(),this.unblockMap("rs")},show:function(e){this.router.searchResultsPageView.toggleNoListings(!1),$("#js-list-view").hide(),$("#js-recent-view").hide(),$("#js-foreclosures-view").hide(),$("#js-map-view").show(),this.loadInit(e.get("location"))},loadInit:function(e){this.listItems=new E.ListItems({view:this,el:"#js-map-listings",type:"listing"}),this.listFCItems=new E.ListItems({view:this,el:"#js-map-foreclosures",type:"foreclosure"}),this.modelMapTab.set("tab","maplistings");var n=new t.Location;n.set({location:e,SiteID:0});var r=n.fetch();arrPending.push(r);var i=this;$.when(r,require(["V7ClientSideClustering"]),require(["http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"])).then(function(e){var t=null;if(e&&e[0]&&e[0].bbox&&e[0].bbox.length==4){t=e[0].bbox;var n,r,s,o=null;t[0]>t[2]?(n=t[0],s=t[2]):(n=t[2],s=t[0]),t[1]<t[3]?(r=t[1],o=t[3]):(r=t[3],o=t[1]),t=[n,r,s,o],e[0].bbox=t,i.setCenter(e[0])}i.mapReady(t)})},loadApi:function(e){},isLoaded:function(){return typeof Microsoft!="undefined"&&typeof Microsoft.Maps!="undefined"&&typeof Microsoft.Maps.Map!="undefined"&&typeof ClusteredEntityCollection!="undefined"},mapReady:function(e){this.doCenterMap=!0,this.doFinishCollecting=!0,this.doRecluster=!0,this.query(e)},getCenter:function(e){var n;n=new t.Location,n.set({location:e,SiteID:0});var r=n.fetch({success:function(e){HMSEvent.trigger("location-complete",e)},error:function(e){HMSEvent.trigger("location-fail",e)}});arrPending.push(r)},query:function(e){this.bbox=e;var t=this.getListings(e),n=this.getForeclosures(e),r=null;$("#js-update-amenities").length>0&&$("#js-update-amenities")[0].checked&&(r=this.getAmenities(e)),$.when(t,n,r).then(this.render)},getListings:function(e){this.blockMap("l");if(this.collection){this.collection.params.pagenumber=1,this.collection.params.maplistings=1,this.collection.params.Count=this.listingsMaxCount,e&&e.length==4&&(this.collection.params.forcelatlong=!1,this.collection.params.nwlat=e[0],this.collection.params.nwlong=e[1],this.collection.params.selat=e[2],this.collection.params.selong=e[3]);var t=this.collection.fetch();return arrPending.push(t),t}return null},addListings:function(e){if(e){var t=this;this.collection.reset(),this.maplids=[],$.each(e,function(e,n){$.inArray(n.i,t.maplids)<0&&t.maplids.push(n.i);var r={};r.ListingID=n.i,r.Latitude=n.a,r.Longitude=n.o,t.collection.add(r)}),this.getMoreListItemsFired=!1,this.loadedIDs=[],this.loadedListings=[]}this.maplids.length>0?(this.getMoreListItems(!0),this.modelMapTab.get("clickedActiveTab")&&this.modelMapTab.get("clickedActiveTab")!=this.modelMapTab.get("tab")&&this.modelMapTab.get("clickedActiveTab")=="maplistings"&&this.modelMapTab.set("tab","maplistings")):(this.modelMapTab.set("tab","mapforeclosures"),this.listItems.showNoResults()),this.listingsClusteredLayer=new ClusteredEntityCollection(this.map,{singlePinCallback:this.createPin,clusteredPinCallback:this.createClusteredPin,clusteringEnabled:!0,gridSize:this.gridSize}),this.listingsClusteredLayer.SetData(this.collection.toJSON()),this.BringActiveLayerToFront(),this.unblockMap("l")},getForeclosures:function(e){this.blockMap("fc");if(this.foreclosures){_.extend(this.foreclosures.params,this.collection.params),this.foreclosures.params.pagenumber=1,this.foreclosures.params.maplistings=1,this.foreclosures.params.Count=this.listingsMaxCount,e&&e.length==4&&(this.foreclosures.params.forcelatlong=!1,this.foreclosures.params.nwlat=e[0],this.foreclosures.params.nwlong=e[1],this.foreclosures.params.selat=e[2],this.foreclosures.params.selong=e[3]);var t=this.foreclosures.fetch();return arrPending.push(t),t}return null},addForeclosures:function(e){if(e){var t=this;this.foreclosures.reset(),this.mapfcids=[],$.each(e,function(e,n){$.inArray(n.i,t.mapfcids)<0&&t.mapfcids.push(n.i);var r={};r.ListingID=n.i,r.Latitude=n.a,r.Longitude=n.o,t.foreclosures.add(r)}),this.getMoreFCListItemsFired=!1,this.loadedFCIDs=[],this.loadedForeclosures=[]}this.mapfcids.length>0?(this.getMoreFCListItems(!0),this.modelMapTab.get("clickedActiveTab")&&this.modelMapTab.get("clickedActiveTab")!=this.modelMapTab.get("tab")&&this.modelMapTab.get("clickedActiveTab")=="mapforeclosures"&&this.modelMapTab.set("tab","mapforeclosures")):(this.modelMapTab.set("tab","maplistings"),this.listFCItems.showNoResults()),this.foreclosuresClusteredLayer=new ClusteredEntityCollection(this.map,{singlePinCallback:this.createForeclosurePin,clusteredPinCallback:this.createForeclosureClusteredPin,clusteringEnabled:!0,gridSize:this.gridSize}),this.foreclosuresClusteredLayer.SetData(this.foreclosures.toJSON()),this.BringActiveLayerToFront(),this.unblockMap("fc")},createMap:function(){var e,t,n=$("#js-refinesearch").find("#location").val(),r={credentials:this.key,mapTypeId:Microsoft.Maps.MapTypeId.auto,enableSearchLogo:!1,enableClickableLogo:!1};this.originalBbox&&this.originalBbox.length==4?(this.originalBounds=Microsoft.Maps.LocationRect.fromCorners(new Microsoft.Maps.Location(this.originalBbox[0],this.originalBbox[1]),new Microsoft.Maps.Location(this.originalBbox[2],this.originalBbox[3])),r.bounds=this.originalBounds):(r.zoom=14,r.center=new Microsoft.Maps.Location(this.centerLat,this.centerLong)),this.map=new Microsoft.Maps.Map(this.elMapHolder,r),this.mapBounds=this.map.getBounds(),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"mousedown",this.onMouseDown),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"mouseup",this.onMouseUp),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"mousemove",this.onMouseMove),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"mousewheel",this.onMapZoom),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"dblclick",this.onMapZoom),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"viewchange",this.onViewChange),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"viewchangestart",this.onViewChangeStart),this.mapChangeEvent=Microsoft.Maps.Events.addHandler(this.map,"viewchangeend",this.onViewChangeEnd),this.defaultCursor=this.map.getRootElement().style.cursor},getBounds:function(){var e=0,t=0,n=0,r=0,i=0,s,o,u;return this.collection&&_.each(this.collection.models,function(u){u.attributes.Latitude!=0&&u.attributes.Longitude!=0&&(s=u.attributes.Latitude,o=u.attributes.Longitude,e==0?(r=s,i=o,t=s,n=o):(s>r&&(r=s),s<t&&(t=s),o>i&&(i=o),o<n&&(n=o)),e+=1)}),this.foreclosures&&_.each(this.foreclosures.models,function(u){u.attributes.Latitude!=0&&u.attributes.Longitude!=0&&(s=u.attributes.Latitude,o=u.attributes.Longitude,e==0?(r=s,i=o,t=s,n=o):(s>r&&(r=s),s<t&&(t=s),o>i&&(i=o),o<n&&(n=o)),e+=1)}),u=Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(r,i),new Microsoft.Maps.Location(t,n)),u},renderMap:function(){this.map||this.createMap(),this.bounds=this.map.getBounds(),this.map.entities.clear(),this.listingsClusteredLayer=null,this.foreclosuresClusteredLayer=null,this.amenitiesClusteredLayer=null,this.recentSalesClusteredLayer=null},blockMap:function(e){this.blockKeys[e]=!0;var t=!0;$.each(this.blockKeys,function(n,r){n!=e&&r&&(t=!1)});if(t){$(".js-loading").show();if(e=="fc"||e=="l"||e=="i")HMSEvent.trigger("ui-show-blocker",{element:"#js-map-lists",overlay:{opacity:.1,cursor:"default"}}),HMSEvent.trigger("ui-show-blocker",{element:".js-map-tabs",overlay:{opacity:0},msg:" "})}},unblockMap:function(e){this.blockKeys[e]=!1;var t=!0;$.each(this.blockKeys,function(e,n){n&&(t=!1)}),t&&$(".js-loading").hide(),e=="i"&&(HMSEvent.trigger("ui-hide-blocker",{element:"#js-map-lists"}),HMSEvent.trigger("ui-hide-blocker",{element:".js-map-tabs"}))},createPin:function(e){var t={typeName:"icon icons-mappin-red-26x24",icon:"",width:19,height:22,id:"pin-"+e.ListingID,infobox:this.pinInfobox},n=new Microsoft.Maps.Pushpin(e._LatLong,t);return n.ListingID=e.ListingID,n.type="listingpin",n.data=e,Microsoft.Maps.Events.addHandler(n,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(n,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(n,"mouseout",$.proxy(this.pinMouseOut,this)),n},createClusteredPin:function(e,t){var n={typeName:"icon icons-mappincluster-red-26x24",icon:"",width:19,height:22,id:"pin-"+this._counter++,infobox:this.pinInfobox},r=new Microsoft.Maps.Pushpin(t,n);return r.isCluster=!0,r.type="listingcluster",r.data=e,Microsoft.Maps.Events.addHandler(r,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(r,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(r,"mouseout",$.proxy(this.pinMouseOut,this)),r},createForeclosurePin:function(e){var t={typeName:"icon icons-mappin-aliceblue-26x24",icon:"",width:19,height:22,id:"pin-"+e.ListingID,infobox:this.pinInfobox},n=new Microsoft.Maps.Pushpin(e._LatLong,t);return n.ListingID=e.ListingID,n.type="foreclosurepin",n.data=e,Microsoft.Maps.Events.addHandler(n,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(n,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(n,"mouseout",$.proxy(this.pinMouseOut,this)),n},createForeclosureClusteredPin:function(e,t){var n={typeName:"icon icons-mappincluster-aliceblue-26x24",icon:"",width:19,height:22,id:"pin-"+this._counter++,infobox:this.pinInfobox},r=new Microsoft.Maps.Pushpin(t,n);return r.isCluster=!0,r.type="foreclosurecluster",r.data=e,Microsoft.Maps.Events.addHandler(r,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(r,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(r,"mouseout",$.proxy(this.pinMouseOut,this)),r},pinMouseOver:function(e){var t=e.target;t.setOptions({zIndex:2}),this.map.getRootElement().style.cursor="pointer",$target=$(e.originalEvent.target),(t.type.indexOf("amenity")!=-1||t.type.indexOf("recentsale")!=-1)&&$target.parent().parent().css("z-index",""),$(e.originalEvent.target).parent().parent().parent().children().each(function(){$(this).css("transform-origin",""),$(this).css("transform",""),$(this).css("-webkit-transform",""),$(this).children().first().css("transform-origin",""),$(this).children().first().css("transform",""),$(this).children().first().css("-webkit-transform","")})},pinMouseOut:function(e){var t=e.target;t.setOptions({zIndex:0}),this.defaultCursor||(this.defaultCursor='url("http://ecn.dev.virtualearth.net/mapcontrol/v7.0/7.0.20131021174501.67/cursors/grab.cur"), move'),this.map.getRootElement().style.cursor=this.defaultCursor},createAmenityPin:function(e){this.getPoiClass(e);var t={typeName:"icon "+e.pushpinClass,icon:"",width:e.pushpinW,height:e.pushpinH,id:"pin-"+this._counter++,infobox:this.pinInfobox},n=new Microsoft.Maps.Pushpin(e._LatLong,t);return n.data=e,n.type="amenitypin",Microsoft.Maps.Events.addHandler(n,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(n,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(n,"mouseout",$.proxy(this.pinMouseOut,this)),n},createAmenityClusteredPin:function(e,t){var n=this;_.each(e,function(e){n.getPoiClass(e)});var r={typeName:"icon icons-mappincluster-gray-26x24",icon:"",width:19,height:22,id:"pin-"+this._counter++,infobox:this.pinInfobox},i=new Microsoft.Maps.Pushpin(t,r);return i.isCluster=!0,i.data=e,i.type="amenitycluster",Microsoft.Maps.Events.addHandler(i,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(i,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(i,"mouseout",$.proxy(this.pinMouseOut,this)),i},createRecentSalePin:function(e){var t={typeName:"icon icons-mappin-blue-26x24",icon:"",width:19,height:22,id:"pin-"+e.sz_id,infobox:this.pinInfobox},n=new Microsoft.Maps.Pushpin(e._LatLong,t);return n.type="recentsalepin",n.data=e,Microsoft.Maps.Events.addHandler(n,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(n,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(n,"mouseout",$.proxy(this.pinMouseOut,this)),n},createRecentSaleClusteredPin:function(e,t){var n={typeName:"icon icons-mappincluster-blue-26x24",icon:"",width:19,height:22,id:"pin-"+this._counter++,infobox:this.pinInfobox},r=new Microsoft.Maps.Pushpin(t,n);return r.isCluster=!0,r.type="recentsalecluster",r.data=e,Microsoft.Maps.Events.addHandler(r,"click",$.proxy(this.showInfobox,this)),Microsoft.Maps.Events.addHandler(r,"mouseover",$.proxy(this.pinMouseOver,this)),Microsoft.Maps.Events.addHandler(r,"mouseout",$.proxy(this.pinMouseOut,this)),r},getPoiClass:function(e){var t="icons-mappin-gray-26x24",n=19,r=22;$.inArray(e.POITypeID,[2003])!=-1&&(t="icons-poi-worship-18x25",n=18,r=25),$.inArray(e.POITypeID,[2005])!=-1&&(t="icons-poi-banks-23x21",n=23,r=21),$.inArray(e.POITypeID,[2004,100])!=-1&&(t="icons-poi-culture-23x21",n=23,r=21),$.inArray(e.POITypeID,[1003])!=-1&&(t="icons-poi-food-23x23",n=23,r=23),$.inArray(e.POITypeID,[200,2001,2002])!=-1&&(t="icons-poi-health-23x23",n=23,r=23),$.inArray(e.POITypeID,[2006])!=-1&&(t="icons-poi-mail-23x23",n=23,r=23),$.inArray(e.POITypeID,[1004,2007])!=-1&&(t="icons-poi-schools-21x23",n=21,r=23),e.pushpinClass=t,e.pushpinW=n,e.pushpinH=r},hidePinInfobox:function(e){this.pinInfobox&&this.pinInfobox.setOptions({visible:!1}),this.BringActiveLayerToFront(),e&&(this.itemClicked=0,this.fcitemClicked=0,this.listItems.setInactive(),this.listFCItems.setInactive()),this.hideToolTip()},hideToolTip:function(){$(".ui-tooltip-focus").hide()},showPinInfobox:function(e){this.pinInfobox&&e&&(this.pinInfobox.setLocation(e.getLocation()),this.pinInfobox.setOptions({visible:!0}))},mapChange:function(e){k();var t=this.map.getBounds().getNorthwest(),n=this.map.getBounds().getSoutheast();this.doCenterMap=!1,this.query([t.latitude,t.longitude,n.latitude,n.longitude])},showInfobox:function(e){var t=this,n=e.target;this.hidePinInfobox();var r=1;e.originalEvent||(this.map.setView({centerOffset:new Microsoft.Maps.Point(0,80),center:n.getLocation()}),r=1e3),n.type.indexOf("listing")!=-1&&(this.modelMapTab.set("tab","maplistings"),this.modelMapTab.set("clickedActiveTab","maplistings")),n.type.indexOf("foreclosure")!=-1&&(this.modelMapTab.set("tab","mapforeclosures"),this.modelMapTab.set("clickedActiveTab","mapforeclosures")),this.showPinInfobox(n),setTimeout(function(){n.isCluster&&e.originalEvent?new E.InfoBoxCluster({pin:n,view:t}):(n.type.indexOf("listing")!=-1&&(new E.InfoBox({pin:n,view:t}),e.originalEvent&&t.listItems.setActive(n.data.ListingID)),n.type.indexOf("foreclosure")!=-1&&(new E.InfoBoxForeclosure({pin:n,view:t}),e.originalEvent&&t.listFCItems.setActive(n.data.ListingID)),(n.type=="amenitypin"||n.type=="recentsalepin")&&new E.InfoBoxPoiRS({pin:n,view:t}))},r),setTimeout(function(){t.map.setView({centerOffset:new Microsoft.Maps.Point(0,80),center:n.getLocation()})},1e3)},centerInfobox:function(e){if($("#"+e.getId()).is(":visible")){$(".js-map-infobox").position({of:$("#"+e.getId()),my:"center bottom",at:"center top"});var t=1;$(".js-map-infobox").css("left",parseInt($(".js-map-infobox").css("left"))-t)}},isInfoBoxVisible:function(){var e=!1;if($(".js-map-infobox").is(":visible")){var t={top:$(".js-map-infobox").offset().top,left:$(".js-map-infobox").offset().left,width:$(".js-map-infobox").width(),height:$(".js-map-infobox").height(),right:$(".js-map-infobox").offset().left+$(".js-map-infobox").width(),bottom:$(".js-map-infobox").offset().top+$(".js-map-infobox").height()},n={top:$("#js-map-container").offset().top,left:$("#js-map-container").offset().left,width:$("#js-map-container").width(),height:$("#js-map-container").height(),right:$("#js-map-container").offset().left+$("#js-map-container").width(),bottom:$("#js-map-container").offset().top+$("#js-map-container").height()},r=t.bottom>n.top&&t.top<n.bottom,i=t.right>n.left&&t.left<n.right;e=r&&i}return e},onRemoveListing:function(e){var t=$(".MapPushpinBase"),n="pin-"+e.id;$.each(t,function(e,t){$(this).attr("id")==n&&$(this).remove()}),HMSEvent.trigger("home-value-hideinfoboxes"),$(".js-map-list-item").each(function(t,n){e.id==$(this).data("info").ListingID&&$(this).remove()})},render:function(e,t,n){if(this.collection.metadata.searchdescriptiondata&&this.collection.metadata.searchdescriptiondata.HandoffSiteURL&&HMSTrackingVars.HandoffSearchType&&HMSTrackingVars.HandoffSearchType=="explicit")this.collection.metadata.office=undefined,window.location=decodeURIComponent(this.collection.metadata.searchdescriptiondata.HandoffSiteURL+this.collection.metadata.searchdescriptiondata.HandoffSiteQuery);else{var r=this;e&&e[1]&&e[1].office&&(window.siteid=e[1].office.OfficeID);if(!this.brandingView.render||this.brandingView.render(this.collection)){this.renderMap(),e&&e[0]&&e[0][0]&&this.addListings(e[0][0]),t&&t[0]&&t[0][0]&&this.addForeclosures(t[0][0]),(this.collection&&this.collection.length>0||this.foreclosures&&this.foreclosures.length>0)&&this.doCenterMap&&this.map.setView({bounds:this.getBounds()}),n&&n[0]&&this.addAmenities(n[0]);if($("#js-update-recent-sales").length>0&&$("#js-update-recent-sales")[0].checked){var i=null;i=this.getRecentSales(this.bbox),$.when(i).then(function(e){e&&e[0]&&r.addRecentSales(e[0])})}this.createPinInfobox(),this.doFinishCollecting&&(this.doFinishCollecting=!1,e&&e[0]&&e[0][1]&&e[0][1].resultcountformatted&&(this.collection.metadata.resultcountformatted=e[0][1].resultcountformatted),e&&e[0]&&e[0][1]&&e[0][1].location&&(this.collection.metadata.location=e[0][1].location),t&&t[0]&&t[0][1]&&t[0][1].resultcountformatted&&(this.foreclosures.metadata.resultcountformatted=t[0][1].resultcountformatted),t&&t[0]&&t[0][1]&&t[0][1].location&&(this.foreclosures.metadata.location=t[0][1].location),this.router.resultsView.finishCollecting({clickedActiveTab:this.modelMapTab.get("clickedActiveTab")}),HMSEvent.trigger("user-update-savedsearch"),this.disclosureView.load(this.collection),this.router.resultsView.mlsListingSourcesView.query()),C()}}},getLoadedListing:function(e){var t=null;if(this.loadedListings&&this.loadedListings.length>0)for(var n=0;n<this.loadedListings.length;n++){var r=this.loadedListings[n];if(parseInt(r.ListingID)==e){t=r;break}}return t},getLoadedForeclosure:function(e){var t=null;if(this.loadedForeclosures&&this.loadedForeclosures.length>0)for(var n=0;n<this.loadedForeclosures.length;n++){var r=this.loadedForeclosures[n];if(parseInt(r.ListingID)==e){t=r;break}}return t},getMoreListItems:function(e){if(!this.getMoreListItemsFired){var n=this,r="",i=this.maplids.length;i>this.lisPageCount&&(i=this.lisPageCount);for(var s=0;s<i;s++)r+=this.maplids.pop()+"_";if(r!=""){var o=new t.Listings;o.params.maplistingids=r,o.params.maplistings=1,o.params.Count=this.lisPageCount,this.blockMap("i"),this.getMoreListItemsFired=!0;var u=o.fetch({success:function(t,r){e&&n.listItems.clear(),n.listItems.addPinItems({listings:r[0]}),n.getMoreListItemsFired=!1,n.unblockMap("i"),n.itemClicked>0&&n.listItems.setActive(n.itemClicked)}});arrPending.push(u)}}},getMoreFCListItems:function(e){if(!this.getMoreFCListItemsFired){var n=this,r="",i=this.mapfcids.length;i>this.lisPageCount&&(i=this.lisPageCount);for(var s=0;s<i;s++)r+=this.mapfcids.pop()+"_";if(r!=""){var o=new t.Foreclosures;o.params.maplistingids=r,o.params.maplistings=1,o.params.Count=this.lisPageCount,this.blockMap("i"),this.getMoreFCListItemsFired=!0;var u=o.fetch({success:function(t,r){e&&n.listFCItems.clear(),n.listFCItems.addPinItems({listings:r[0]}),n.getMoreFCListItemsFired=!1,n.unblockMap("i"),n.fcitemClicked>0&&n.listFCItems.setActive(n.fcitemClicked)}});arrPending.push(u)}}},setCenter:function(e){this.centerLat=e.latitude,this.centerLong=e.longitude,this.originalBbox=e.bbox},onMouseDown:function(e){x=!0,T=!1},onMouseUp:function(e){x=!1},onMouseMove:function(e){x&&!T&&(T=!0)},onMapZoom:function(e){T=!0,x=!1,this.hidePinInfobox()},onViewChange:function(e){},onViewChangeStart:function(e){this.hideToolTip()},onViewChangeEnd:function(e){this.hideToolTip(),this.doRecluster&&(this.doRecluster=!1,this.listingsClusteredLayer.Cluster(),this.foreclosuresClusteredLayer.Cluster()),!x&&T&&!this.isInfoBoxVisible()&&(T=!1,this.mapChange())},hide:function(){$(this.el).hide()},getPin:function(e){if(this.map&&this.map.entities&&this.map.entities.getLength()>0)for(var t=0;t<this.map.entities.getLength();t++){layer=this.map.entities.get(t);if(layer.clear!=null)for(var n=0;n<layer.getLength();n++){pin=layer.get(n);if(pin.isCluster)for(var r=0;r<pin.data.length;r++){var i=pin.data[r];if(parseInt(i.ListingID)==parseInt(e))return pin}else if(parseInt(pin.data.ListingID)==parseInt(e))return pin}else if(layer.data&&layer.data.ListingID&&parseInt(layer.data.ListingID)==parseInt(e))return layer}}}),E.ListItems=e.View.extend({events:{"click .js-map-list-item":"onListItemClick",scroll:"onScroll"},data:null,pin:null,template:null,view:null,items:[],loadedIDs:null,loadedItems:null,itemClicked:null,itemsClusteredLayer:null,mapItemIDs:null,getMoreListItems:null,initialize:function(e){_.bindAll(this,"render","onListItemClick","onScroll","setActive","setInactive","addPinItemsCallback","showNoResults","addPinItems","scrollTop","show"),this.view=e.view,this.type=e.type;var t=this;this.type=="listing"&&(this.template=c,this.loadedIDs="loadedIDs",this.loadedItems="loadedListings",this.itemClicked="itemClicked",this.mapItemIDs="maplids",this.itemsClusteredLayer="listingsClusteredLayer",this.getMoreListItems=this.view.getMoreListItems,this.collection="collection"),this.type=="foreclosure"&&(this.template=h,this.loadedIDs="loadedFCIDs",this.loadedItems="loadedForeclosures",this.itemClicked="fcitemClicked",this.mapItemIDs="mapfcids",this.itemsClusteredLayer="foreclosuresClusteredLayer",this.getMoreListItems=this.view.getMoreFCListItems,this.collection="foreclosures")},show:function(){this.view[this.loadedIDs].length==0&&this.getMoreListItems(),$(".js-map-panels").hide(),this.$el.show(),this.view.activeLayer=this.itemsClusteredLayer,this.view.BringActiveLayerToFront(),this.view[this.collection].metadata.type=this.type,this.view.updateSearchResults(this.view[this.collection].metadata)},addPinItems:function(e){this.pinItemArgs=e,this.template&&HMSTemplate.get(this.template,this.addPinItemsCallback)},addPinItemsCallback:function(e){this.itemTemplate=e;var t=this.pinItemArgs,n=this;t.listing&&this.addOneLI(this,t.listing),t.listings&&$.each(t.listings,function(e,t){n.addOneLI(n,t)}),HMSEvent.trigger("ui-foreclosure-pricetooltip")},addOneLI:function(e,t){if($.inArray(t.ListingID,e.view[e.loadedIDs])<0){e.view[e.loadedIDs].push(t.ListingID),e.view[e.loadedItems].push(t);var n=$(e.itemTemplate.render(t)),r=e.$el.scrollTop();e.$el.append(n),e.$el.scrollTop(r),s.GetThumbnail(n.find("img"))}},deleteOne:function(e){var t=this.getItem(e);t&&t.length>0&&t.remove()},setActive:function(e){this.setInactive();var t=this.getItem(e);t&&t.length>0&&(t.addClass("active skin-19"),this.centerActive(t))},setInactive:function(){this.$el.children().removeClass("active skin-19")},centerActive:function(e){this.$el.animate({scrollTop:e.offset().top-this.$el.offset().top+this.$el.scrollTop()-(this.$el.outerHeight()/2-e.height()/2)},1500)},clear:function(){this.$el.empty()},onListItemClick:function(e){var t=parseInt($(e.currentTarget).data("info").ListingID);if(this.view[this.itemClicked]!=t){this.setActive(t);var n=$(e.currentTarget).data("info").Lat,r=$(e.currentTarget).data("info").Long;this.centerActiveOnMap(new Microsoft.Maps.Location(n,r)),this.view[this.itemClicked]=t;var i=this.view.getPin(t);i||(this.view[this.itemsClusteredLayer]&&this.view[this.itemsClusteredLayer].SetData(this.loadedItems),i=this.view.getPin(t)),i&&this.view.showInfobox({target:i})}},centerActiveOnMap:function(e){this.view.map.setView({centerOffset:new Microsoft.Maps.Point(0,80),center:e})},getItem:function(e){var t=this.$el.children(),n=null;return t&&t.length>0&&t.each(function(){$(this)&&$(this).data("info")&&$(this).data("info").ListingID&&parseInt($(this).data("info").ListingID)==parseInt(e)&&(n=$(this))}),n},onScroll:function(e){this.view.hideToolTip(),this.$el.scrollTop()+6*this.$el.innerHeight()>=this.$el[0].scrollHeight&&this.view[this.mapItemIDs].length>0&&this.getMoreListItems()},showNoResults:function(){this.clear(),this.$el.append('<li class="msg error pad-gutter-all margin-left" style="height:600px;font-size:150%;text-align:center;padding-top:245px;overflow:hidden;">No results returned.<br>  Refine your search or change your location</li>'),this.view.unblockMap("i")},scrollTop:function(e){this.$el.scrollTop(e)}}),E.InfoBoxPoiRS=e.View.extend({el:".js-map-infobox",events:{"click .js-close-infobox":"onCloseClick"},data:null,pin:null,template:null,view:null,initialize:function(e){_.bindAll(this,"renderCallback"),this.view=e.view,this.pin=e.pin,this.data=this.pin.data,this.pin&&this.pin.type=="amenitypin"&&(this.templatePath=g),this.pin&&this.pin.type=="recentsalepin"&&(this.templatePath=y);if(this.pin&&this.pin.type=="recentsalepin"){var t=this,n=this.data.sz_id;if(n!=""){var r=new f.NearByListings;r.attributes={},r.attributes.nometadata=!0,r.attributes.Count=100,r.attributes.maplistings=!0,r.attributes.maplistingids=n,t.view.blockMap("rs2");var i=r.fetch({success:function(e,n){t.data=n[0],t.render(),t.view.unblockMap("rs2")}});arrPending.push(i)}}else this.render()},render:function(){HMSTemplate.get(this.templatePath,this.renderCallback)},renderCallback:function(e){this.view.itemClicked=0,this.view.fcitemClicked=0,this.view.listItems.setInactive(),this.view.listFCItems.setInactive();if(e&&this.data){var t=e.render(this.data);this.$el.replaceWith(t),this.setElement($(".js-map-infobox")),this.view.centerInfobox(this.pin)}},onCloseClick:function(e){this.view.hidePinInfobox(!0)}}),E.InfoBoxForeclosure=e.View.extend({el:".js-map-infobox",events:{"click #js-get-price":"onGetPriceClick","click .js-close-infobox":"onCloseClick"},data:null,pin:null,template:null,view:null,initialize:function(e){_.bindAll(this,"renderCallback"),this.view=e.view,this.pin=e.pin;var n;this.pin.data.length>0?n=parseInt(this.view.fcitemClicked):n=parseInt(this.pin.ListingID),this.data=this.view.getLoadedForeclosure(n);if(this.data)this.render();else{var r=new t.Listing;r.set("IsForeclosure",!0),r.params.ListingID=n;var i=this;i.view.blockMap("i");var s=r.fetch({success:function(e,t){i.data=e.toJSON(),i.view.listFCItems.addPinItems({listing:i.data}),i.view.listFCItems.setActive(i.data.ListingID),i.render(),i.view.unblockMap("i"),i.view.mapfcids.length>0&&i.view.getMoreFCListItems()}});arrPending.push(s)}},render:function(){HMSTemplate.get(b,this.renderCallback)},renderCallback:function(e){this.view.fcitemClicked=this.data.ListingID;if(e&&this.data){var t=e.render(this.data);this.$el.replaceWith(t),this.setElement($(".js-map-infobox"))}this.view.centerInfobox(this.pin),HMSEvent.trigger("user-update-savedlistings"),HMSEvent.trigger("ui-prepare-detaillink"),HMSEvent.trigger("ui-foreclosure-pricetooltip")},onCloseClick:function(e){this.view.hidePinInfobox(!0)},onGetPriceClick:function(e){HMSEvent.trigger("user-savelisting",e)}}),E.InfoBoxCluster=e.View.extend({el:".js-map-infobox",events:{"click .js-close-infobox":"onCloseClick",mousedown:"onEvent"},data:null,pin:null,template:null,view:null,initialize:function(e){_.bindAll(this,"renderCallback","processListingCluster","processForeclosureCluster","processRecenSaleCluster"),this.view=e.view,this.pin=e.pin,this.data=this.pin.data,this.pendingRender=!1,this.pin&&this.pin.type=="listingcluster"&&(this.templatePath=d,this.processListingCluster());if(this.pin&&this.pin.type=="foreclosurecluster"){this.templatePath=w;var t=!1;this.view.loadedForeclosures.length==0&&(t=!0),this.processForeclosureCluster(),t&&this.view.getMoreFCListItems()}this.pin&&this.pin.type=="recentsalecluster"&&(this.templatePath=m,this.processRecenSaleCluster()),this.pin&&this.pin.type=="amenitycluster"&&(this.templatePath=v),this.pendingRender||this.render()},processListingCluster:function(){if(this.pin&&this.pin.type=="listingcluster"){this.pendingRender=!0;var e=this,n="",r=[];$.each(this.data,function(t,i){var s=e.view.getLoadedListing(i.ListingID);s?r.push(s):n+=i.ListingID+"_"});if(n!=""){var i=new t.Listings;i.params.maplistingids=n,i.params.maplistings=1,i.params.Count=100,e.view.blockMap("i");var s=i.fetch({success:function(t,n){e.data=n[0],e.view.listItems.addPinItems({listings:e.data}),r.length>0&&$.each(r,function(t,n){e.data.push(n)}),e.render(),e.view.unblockMap("i")}});arrPending.push(s)}else r.length>0&&(this.data=r,this.render())}},processForeclosureCluster:function(){if(this.pin&&this.pin.type=="foreclosurecluster"){this.pendingRender=!0;var e=this,n="",r=[];$.each(this.data,function(t,i){var s=e.view.getLoadedForeclosure(i.ListingID);s?r.push(s):n+=i.ListingID+"_"});if(n!=""){var i=new t.Foreclosures;i.params.maplistingids=n,i.params.maplistings=1,i.params.Count=100,e.view.blockMap("i");var s=i.fetch({success:function(t,n){e.data=n[0],e.view.listFCItems.addPinItems({listings:e.data}),r.length>0&&$.each(r,function(t,n){e.data.push(n)}),e.render(),e.view.unblockMap("i")}});arrPending.push(s)}else r.length>0&&(this.data=r,this.render())}},processRecenSaleCluster:function(){if(this.pin&&this.pin.type=="recentsalecluster"){this.pendingRender=!0;var e=this,t="";$.each(this.data,function(e,n){t+=n.sz_id+"_"});if(t!=""){var n=new f.NearByListings;n.attributes={},n.attributes.nometadata=!0,n.attributes.Count=100,n.attributes.maplistings=!0,n.attributes.maplistingids=t,e.view.blockMap("rs2");var r=n.fetch({success:function(t,n){e.data=n,e.render(),e.view.unblockMap("rs2")}});arrPending.push(r)}}},render:function(){HMSTemplate.get(this.templatePath,this.renderCallback)},renderCallback:function(e){this.view.itemClicked=0,this.view.fcitemClicked=0,this.view.listItems.setInactive(),this.view.listFCItems.setInactive();if(e&&this.data&&this.data.length>0){var t=e.render({Count:this.data.length,ClusterInfo:this.data});this.$el.replaceWith(t),this.setElement($(".js-map-infobox")),this.view.centerInfobox(this.pin),HMSEvent.trigger("ui-prepare-detaillink"),C()}},onCloseClick:function(e){this.view.hidePinInfobox(!0)},onEvent:function(e){e.stopPropagation()}}),E.InfoBox=e.View.extend({el:".js-map-infobox",events:{click:"onClick","click .js-close-infobox":"onCloseClick","click #js-view-details":"onViewDetailsClick","click #js-sched-showing":"onSchedClick","click #js-get-price":"onGetPriceClick","click #js-hide-listing":"onHideListingClick","click .js-info-next":"onNextClick","click .js-info-prev":"onPrevClick","click #js-info-photos":"onPhotosClick","click #js-info-balloon":"onBalloonClick"},data:null,pin:null,template:null,view:null,initialize:function(e){_.bindAll(this,"render","renderCallback","setupViewer","startMap","onHideListingClick"),this.view=e.view,this.pin=e.pin;var n;this.pin.data.length>0?n=parseInt(this.view.itemClicked):n=parseInt(this.pin.ListingID),this.data=this.view.getLoadedListing(n);if(this.data)this.render();else{var r=new t.Listing;r.params.ListingID=n;var i=this;i.view.blockMap("i");var s=r.fetch({success:function(e,t){i.data=e.toJSON(),i.view.listItems.addPinItems({listing:i.data}),i.view.listItems.setActive(i.data.ListingID),i.render(),i.view.unblockMap("i"),i.view.maplids.length>0&&i.view.getMoreListItems()}});arrPending.push(s)}},render:function(){HMSTemplate.get(p,this.renderCallback)},renderCallback:function(e){this.view.itemClicked=this.data.ListingID,this.data.isPhotos=!1,this.data.ListingImages==null||this.data.ListingImages.length<1?(this.data.showSingle=!0,this.data.showViewer=!this.data.showSingle,!this.data.IDXPhotoRef==""&&(this.data.isPhotos=!0)):(this.data.showViewer=!0,this.data.showSingle=!this.data.showViewer,this.data.isPhotos=!0),this.data.IDXPhotoRef==""&&this.data.ListingImages==null&&(this.data.isPhotos=!1);if(e&&this.data){var t=e.render(this.data);this.$el.replaceWith(t),this.setElement($(".js-map-infobox"))}this.data.isPhotos==0?($("#js-info-map").show(),this.startMap()):this.setupViewer(),this.view.centerInfobox(this.pin),HMSEvent.trigger("user-update-savedlistings"),HMSEvent.trigger("ui-prepare-detaillink"),C()},setupViewer:function(){this.setElement($(".js-map-infobox")),$(".js-infobox-gallery > li").css({display:"none"}),$(".js-infobox-gallery > li:first").css({display:"block"})},startMap:function(){var e={};e.Longitude=this.data.Longitude,e.Latitude=this.data.Latitude,this.mapView=new E.MiniMap(e)},onClick:function(){},onBalloonClick:function(){$("#js-info-viewer").hide(),$("#js-info-map").show(),$("#js-info-photos").removeClass("btn-skin btn-5"),$("#js-info-photos").addClass("pad-horizontal"),$("#js-info-balloon").removeClass("pad-horizontal"),$("#js-info-balloon").addClass("btn-skin btn-5"),this.startMap()},onPhotosClick:function(){$("#js-info-viewer").show(),$("#js-info-map").hide(),$("#js-info-balloon").removeClass("btn-skin btn-5"),$("#js-info-balloon").addClass("pad-horizontal"),$("#js-info-photos").removeClass("pad-horizontal"),$("#js-info-photos").addClass("btn-skin btn-5")},onPrevClick:function(e){var t=10,n=$("ul.js-infobox-gallery").children(":visible"),r=$("ul.js-infobox-gallery").children(":last"),i=n.prev();i=i.index()==-1?r:i,n.fadeOut(t,function(){i.fadeIn(t)})},onNextClick:function(e){var t=10,n=$("ul.js-infobox-gallery").children(":visible"),r=$("ul.js-infobox-gallery").children(":first"),i=n.next();i=i.index()==-1?r:i,n.fadeOut(t,function(){i.fadeIn(t)})},onCloseClick:function(){this.view.hidePinInfobox(!0)},onViewDetailsClick:function(e){},onSchedClick:function(e){var t=null;e&&(t=$(e.currentTarget).data("listingid")),t||(t=$(e.currentTarget).parent().data("listingid")),HMSEvent.trigger("ui-modal-open",{contactform:"requestshowing-modal",data:{requestashowing:!0,ListingID:t}})},onGetPriceClick:function(e){HMSEvent.trigger("user-savelisting",e)},onHideListingClick:function(e){e.currentTarget.className.indexOf("js-user-hidelisting")!=-1&&HMSEvent.trigger("user-hidelisting",{e:e,callback:this.onAfterHideListing,args:{id:this.data.ListingID,self:this}}),e.currentTarget.className.indexOf("js-user-listinghidden")!=-1&&HMSEvent.trigger("user-unhidelisting",{e:e,callback:this.onAfterHideListing,args:{id:this.data.ListingID,self:this}}),this.view.hidePinInfobox()},onAfterHideListing:function(e){var t=e.self;t.pin.setOptions({visible:!1}),HMSEvent.trigger("remove-map-listing",{id:e.id})}}),E.MiniMap=e.View.extend({name:"js-info-map-mini",settings:{},initialize:function(e){settings=e,this.miniKey=$(".js-mapsearch").attr("data-key"),this.elMiniMapHolder=$("#js-info-map-container")[0],this.loadApi()},loadApi:function(){HMSEvent.on("mini-map-api-loaded",this.mapReady),this.isLoaded()&&this.mapReady()},isLoaded:function(){return typeof Microsoft!="undefined"&&typeof Microsoft.Maps!="undefined"&&typeof Microsoft.Maps.Map!="undefined"},mapReady:function(){this.miniMapType=Microsoft.Maps.MapTypeId.birdseye,this.zoom=18,this.map=new Microsoft.Maps.Map(this.elMiniMapHolder,{credentials:this.miniKey,center:new Microsoft.Maps.Location(settings.Latitude,settings.Longitude),mapTypeId:this.miniMapType,zoom:this.zoom,showDashboard:!1,enableSearchLogo:!1,enableClickableLogo:!1}),this.addListing(this.centerLat,this.centerLong)},addListing:function(){this.map.entities.clear();var e=new Microsoft.Maps.Pushpin(this.map.getCenter(),{typeName:"icon icons-mappin-red-26x24",icon:"",width:19,height:22});this.map.entities.push(e)}});var N=null;return E.AbortPending=function(){k()},S=E,S})