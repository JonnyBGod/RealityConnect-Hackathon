define(["backbonestore","app/mediators/form","app/models/search","text!templates/search/search-header.html","app/ui-modules/autocomplete/view","hmsglobal","app/ui-modules/modal/view","app/ui-modules/animate/animate","innershiv"],function(e,t,n,r,i,s,o,u){var a={},f={},l="text!templates/listings/results-list-empty.html",c=Hogan.compile(r);return a.SearchResultsPage=e.View.extend({el:"#page",settings:{},route:"",name:"js-searchresultspage-view",model:new n.Search,collection:new n.Listings(this),baseRoute:"search",initialize:function(t){_.bindAll(this,"render","navRoute","block","unblock","getRoute","toggleBlock","pageRoute","toggleNoListings"),_.extend(this.settings,t),this.router=t,this.collection.parentName=this.name},pageRoute:function(e){this.navRoute(e)},navRoute:function(e){var t;t=this.baseRoute+this.getRoute(e),$("#js-search-results-sort").show(),$("#js-refinesearch-propertytype").show(),this.router.tabsView.active=="map"?$("#js-search-results-sort").hide():this.router.tabsView.active=="recent"&&$("#js-refinesearch-propertytype").hide();var n=window.location.toString(),r=window.location.toString();this.router.tabsView.active=="foreclosures"?r=r.replace("realestatehomesforsale","realestateforeclosures"):r=r.replace("realestateforeclosures","realestatehomesforsale"),r=r.replace("-condos-","-");if(this.model.attributes.listingtypeid&&this.model.attributes.listingtypeid=="104"&&r.indexOf("realestateforeclosures")==-1){var i=r.match(/-p\d{0,15}\.html/i);i&&i.length==1&&(r=r.replace(i[0],"-condos"+i[0]))}n!=r&&history.replaceState("data","",r),this.router.navigate(t,{trigger:!0})},getRoute:function(e){var t="";return e||(e=1),this.model.set("pagenumber",e),this.model.set("tab",this.router.tabsView.active),(this.model.get("tab")=="foreclosures"||this.model.get("tab")=="recent")&&(this.model.get("sortorder")=="miraclehome"||this.model.get("sortorder")=="pricereduction")&&(this.model.set("sortorder","pricehigh"),$("#sortorder").val(this.model.get("sortorder"))),t="/"+this.model.getRoute(),t},toggleBlock:function(e){if(this.router.tabsView.active!="map"){var t=$("#js-"+this.router.tabsView.active+"-view, [data-id='js-nolistings']");e=="block"?t.block({centerX:!1,centerY:!1,css:{top:"48%",left:"48%"}}):t.unblock()}},block:function(){this.toggleBlock("block")},unblock:function(){this.toggleBlock("unblock")},toggleNoListings:function(e){e?(HMSEvent.trigger("js-no-listings"),$("[data-id='js-results-message']").show(),$("[data-id='js-results-list']").hide()):($("[data-id='js-results-message']").hide(),$("[data-id='js-results-list']").show())},toggleMapTabNoListing:function(){$("[data-id='js-results-message']").hide(),$("[data-id='js-results-list']").show(),this.router.tabsView.tabs.openTab()}}),a.Message=e.View.extend({name:"js-results-message",el:"[data-id='js-results-message']",initialize:function(e){_.bindAll(this,"showNoListings","showNoListingsCallback"),HMSEvent.on("js-no-listings",this.showNoListings)},showNoListings:function(){HMSTemplate.get(l,this.showNoListingsCallback)},showNoListingsCallback:function(e){var t,n;n=e.render(),this.$el.html(n)}}),a.Search=e.View.extend({name:"js-search-view",el:"[data-id='js-searchresults-view']",events:{"click #js-newlistings":"execFilter","click #js-openhouses":"execFilter","click #js-pricecuts":"execFilter","click #js-hidden":"execFilter","click #js-luxuryhomes":"execFilter","click #js-virtualtours":"execFilter","click  #js-refinesearch-submit":"refineSearch",keypress:"handleKeypress","click a[data-formid]":"handleAnchor","click [data-id='js-mlsselector']":"showSources"},settings:{},initialize:function(n){_.bindAll(this,"render","refineSearch","handleKeypress","execFilter","prepSearchModel","closeDropdowns","handleAnchor","toggleShowOnly","showSources","showMoreLink","searchRedirect","updateHeaderResults"),_.extend(this.settings,n),this.router=n,this.pageView=this.settings.searchResultsPageView,this.mediator=t.Mediator({model:this.pageView.model}),this.prepSearchModel(),this.refineDisplay(),HMSEvent.on("hms-mlsselector-ready",this.showMoreLink),HMSEvent.on("hms-mlsselector-click",this.handleAnchor),HMSEvent.on("hms-redirect-search",this.searchRedirect)},searchRedirect:function(e){var r=new n.SeoModel,i=t.Mediator({model:r}),o="";e&&e.SearchSiteURL&&(o="http://"+e.SearchSiteURL),i.prepareModel($("[data-id='js-searchresults-view']")),r.set("tab",this.router.tabsView.active),r.fetch({success:function(t){var n=t.toJSON(),r="";if(n.Success==1){var i=$.cookie("rmxaid");i||(i=s.getQueryVal("rmxaid"),i&&$.cookie("rmxaid",i)),i&&(r="&rmxaid="+i);var u="",a=0,f=$.cookie("token");HMSUser&&HMSUser.model&&HMSUser.model.get("ContactID")&&(a=HMSUser.model.get("ContactID")),f&&(u="&contactid="+a+"&token="+f);var l="";e&&e.lsid&&e.lsid!=""&&(l="&lsid-"+e.lsid),window.location.href=o+n.SEOUrl+r+u+l}}})},refineDisplay:function(){s.formatInputtedPrice(["#js-maxprice","#js-minprice"]),$("#js-maxprice").val(s.number_format($("#js-maxprice").val(),null,null,",",!0)),$("#js-minprice").val(s.number_format($("#js-minprice").val(),null,null,",",!0))},showMoreLink:function(){$("[data-id='js-mlsselector']").show()},showSources:function(e){e.preventDefault(),HMSEvent.trigger("hms-show-mlsselector",e)},toggleShowOnly:function(e){},toggleShowOnlyForeclosures:function(e){},prepSearchModel:function(){this.mediator.prepareModel($("[data-id='js-searchresults-view']"))},execFilter:function(e){this.pageView.navRoute()},handleAnchor:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.attr("href").replace(/#/,""),r=t.attr("data-formid"),i=$("#"+r);i.attr("value",n),i.trigger("change"),this.pageView.navRoute()},render:function(){i.execute()},handleKeypress:function(e){e.keyCode==13&&($(e.target).trigger("blur"),this.refineSearch(e))},refineSearch:function(t){t.preventDefault(),HMSEvent.trigger("abort-autocomplete"),HMSTrackingVars.HandoffSearchType="explicit",$.cookie("HandoffSearchType","explicit",{path:"/"}),this.pageView.navRoute()},closeDropdowns:function(){var e=$(".dropdown").filter(".open");e.removeClass("open")},updateHeaderResults:function(e){e.ForSaleHeader&&(HMSBranding("ON"),!e.searchLocation&&this.listingsdata&&this.listingsdata.searchLocation&&(e.searchLocation=this.listingsdata.searchLocation),!e.searchTitleListingSourceName&&this.listingsdata&&this.listingsdata.searchTitleListingSourceName&&(e.searchTitleListingSourceName=this.listingsdata.searchTitleListingSourceName),e.resultcountformatted||(this.listingsdata&&this.listingsdata.resultcountformatted?e.resultcountformatted=this.listingsdata.resultcountformatted:e.resultcountformatted="0")),e.RecentHeader&&(HMSBranding("OFF"),!e.searchLocation&&this.recentsalesdata&&this.recentsalesdata.searchLocation&&(e.searchLocation=this.recentsalesdata.searchLocation),e.resultcountformatted||(this.recentsalesdata&&this.recentsalesdata.resultcountformatted?e.resultcountformatted=this.recentsalesdata.resultcountformatted:e.resultcountformatted="0")),e.ForeclosuresHeader&&(HMSBranding("OFF"),!e.searchLocation&&this.foreclosuresdata&&this.foreclosuresdata.searchLocation&&(e.searchLocation=this.foreclosuresdata.searchLocation),e.resultcountformatted||(this.foreclosuresdata&&this.foreclosuresdata.resultcountformatted?e.resultcountformatted=this.foreclosuresdata.resultcountformatted:e.resultcountformatted="0"));if(e.searchLocation){var t=e.searchLocation.split(","),n=_.trim(t[1]),r=_.trim(t[0]),i,s,o;$.isNumeric(r)?(e.zip=r,o=r):r.length>0&&n.length>0&&(n=_.titleize(n),e.state=n,r.toLowerCase().indexOf("county")!=-1?(i=r.toLowerCase().replace("county","").trim(),i=_.titleize(i),e.county=i,o=i):r.toLowerCase().indexOf("neighborhood")!=-1?(s=r.toLowerCase().replace("neighborhood","").trim(),s=_.titleize(s),e.neighborhood=s,o=s):(e.city=_.titleize(r),o=r)),e.titlecity=e.zip||e.county||e.neighborhood||e.city}$.each(e,function(t,n){n==""&&(e[t]=null)}),e.ForSaleHeader&&(this.listingsdata=e),e.RecentHeader&&(this.recentsalesdata=e),e.ForeclosuresHeader&&(this.foreclosuresdata=e);var u=c.render(e);$("#js-searchResults").html(u),this.setElement("[data-id='js-searchresults-view']")},updateRefineSearch:function(e){!e&&this.router&&this.router&&this.router.tabsView.active=="foreclosures"&&(e={ForeclosuresHeader:!0});var t=!1;HMSUser&&HMSUser.model.get("isForeclosureAuth")&&(t=!0),e.ForeclosuresHeader?(t?$("#js-ageofhome").show():$("#js-ageofhome").hide(),$("#js-refinesearch-salestatus").show(),$("#js-saletype").hide(),$("#js-pricereduction-sort").hide(),$("#js-refinesearch-lotsize").hide(),$("#js-miraclehome-sort").hide()):($("#js-refinesearch-salestatus").hide(),$("#js-saletype").show(),$("#js-ageofhome").show(),$("#js-refinesearch-lotsize").show(),this.router&&this.router.tabsView.active=="list"?($("#js-pricereduction-sort").show(),$("#js-miraclehome-sort").show()):($("#js-pricereduction-sort").hide(),$("#js-miraclehome-sort").hide()));if($("#sortorder").val()){console.log($("#sortorder").val()),$("li[id*='-sort']").removeClass("sorthighlight");var n="#js-"+$("#sortorder").val()+"-sort";$(n).addClass("sorthighlight")}}}),f=a,f})